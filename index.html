<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Theme Color for browsers -->
    <meta name="theme-color" content="#0284c7"/>

    <title>S·ªï Thu Chi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .summary-card {
            transition: transform 0.2s ease-in-out;
        }
        .summary-card:hover {
            transform: translateY(-4px);
        }
        .transaction-item:last-child {
            border-bottom: none;
        }
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        /* Animation for error box */
        @keyframes pulse-border {
          0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
          70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
          100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .pulsing-error {
          animation: pulse-border 2s infinite;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    
    <!-- AUTHENTICATION ERROR OVERLAY -->
    <div id="auth-error-overlay" class="fixed inset-0 bg-white z-50 p-6 text-center flex items-center justify-center hidden">
        <div class="max-w-2xl mx-auto border-4 border-orange-500 rounded-2xl p-8 shadow-2xl pulsing-error">
            <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h1 class="text-3xl font-bold text-orange-600 mt-4 mb-4">H√ÄNH ƒê·ªòNG B·∫ÆT BU·ªòC</h1>
            <p class="text-gray-700 text-lg mb-6">B·∫°n c·∫ßn b·∫≠t "ƒêƒÉng nh·∫≠p ·∫©n danh" trong Firebase ƒë·ªÉ ·ª©ng d·ª•ng ho·∫°t ƒë·ªông.</p>
            <div class="text-left bg-gray-100 p-4 rounded-lg border border-gray-200 space-y-3">
                <p><strong>B∆∞·ªõc 1:</strong> M·ªü <a href="https://console.firebase.google.com/" target="_blank" class="text-blue-600 underline font-semibold">Firebase Console</a>, v√†o d·ª± √°n c·ªßa b·∫°n, ch·ªçn m·ª•c <strong>Authentication</strong> t·ª´ menu b√™n tr√°i.</p>
                <p><strong>B∆∞·ªõc 2:</strong> Nh·∫•p v√†o tab <strong>Sign-in method</strong>.</p>
                <p><strong>B∆∞·ªõc 3:</strong> Nh·∫•n n√∫t <strong>Add new provider</strong>, ch·ªçn <strong>Anonymous</strong>, g·∫°t n√∫t **Enable** v√† nh·∫•n **Save**.</p>
            </div>
            <p class="mt-6 text-base text-gray-600">Sau khi b·∫≠t t√≠nh nƒÉng n√†y, h√£y <a href="javascript:location.reload();" class="text-blue-600 underline font-semibold">t·∫£i l·∫°i trang n√†y</a>.</p>
        </div>
    </div>

    <!-- GEMINI API ERROR OVERLAY - NEW -->
    <div id="gemini-error-overlay" class="fixed inset-0 bg-white z-50 p-6 text-center flex items-center justify-center hidden">
        <div class="max-w-2xl mx-auto border-4 border-red-500 rounded-2xl p-8 shadow-2xl pulsing-error">
            <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <h1 class="text-3xl font-bold text-red-600 mt-4 mb-4">L·ªñI C·∫§U H√åNH AI</h1>
            <p class="text-gray-700 text-lg mb-6">T√≠nh nƒÉng "Nh·∫≠p b·∫±ng AI" c·∫ßn m·ªôt API Key (ch√¨a kh√≥a) ƒë·ªÉ ho·∫°t ƒë·ªông. Vui l√≤ng l√†m theo c√°c b∆∞·ªõc sau:</p>
            <div class="text-left bg-gray-100 p-4 rounded-lg border border-gray-200 space-y-3">
                <p><strong>B∆∞·ªõc 1:</strong> Truy c·∫≠p <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 underline font-semibold">Google AI Studio</a> ƒë·ªÉ l·∫•y API Key.</p>
                <p><strong>B∆∞·ªõc 2:</strong> Nh·∫•n v√†o n√∫t "<strong>Create API key</strong>".</p>
                <p><strong>B∆∞·ªõc 3:</strong> Sao ch√©p chu·ªói k√Ω t·ª± API Key v·ª´a ƒë∆∞·ª£c t·∫°o.</p>
                <p><strong>B∆∞·ªõc 4:</strong> M·ªü file <code>index.html</code> tr√™n GitHub, t√¨m ƒë·∫øn d√≤ng `const geminiApiKey = "YOUR_GEMINI_API_KEY";` v√† d√°n API Key c·ªßa b·∫°n v√†o ƒë√≥.</p>
            </div>
            <p class="mt-6 text-base text-gray-600">Sau khi c·∫≠p nh·∫≠t, Vercel s·∫Ω t·ª± ƒë·ªông tri·ªÉn khai l·∫°i v√† t√≠nh nƒÉng AI s·∫Ω ho·∫°t ƒë·ªông.</p>
        </div>
    </div>

    <!-- MAIN CONTAINER -->
    <div id="main-container" class="container mx-auto max-w-2xl p-4 md:p-6">
        
        <!-- HEADER -->
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-900">S·ªï Thu Chi</h1>
            <p class="text-gray-500 mt-1">Qu·∫£n l√Ω t√†i ch√≠nh c√° nh√¢n c·ªßa b·∫°n m·ªôt c√°ch th√¥ng minh.</p>
        </header>

        <!-- SUMMARY SECTION - UPDATED -->
        <section id="summary" class="grid grid-cols-2 md:grid-cols-2 gap-4 mb-6">
            <div class="summary-card bg-white p-4 rounded-xl border border-gray-200 shadow-sm col-span-2 grid grid-cols-2 gap-4">
                 <div>
                    <h3 class="text-sm font-medium text-green-600">T·ªïng Thu</h3>
                    <p id="total-income" class="text-xl font-semibold text-green-500">0 ‚Ç´</p>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-red-600">T·ªïng Chi</h3>
                    <p id="total-expense" class="text-xl font-semibold text-red-500">0 ‚Ç´</p>
                </div>
            </div>
            <div class="summary-card bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                <h3 class="text-sm font-medium text-blue-600">S·ªë d∆∞ ti·ªÅn m·∫∑t</h3>
                <p id="cash-balance" class="text-2xl font-semibold text-blue-500">0 ‚Ç´</p>
            </div>
            <div class="summary-card bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                <h3 class="text-sm font-medium text-indigo-600">S·ªë d∆∞ t√†i kho·∫£n</h3>
                <p id="bank-balance" class="text-2xl font-semibold text-indigo-500">0 ‚Ç´</p>
            </div>
        </section>

        <!-- QUICK ADD SECTION - NEW -->
        <section id="quick-add-section" class="mb-6">
            <h2 class="text-xl font-semibold mb-3 text-gray-800">Ghi nhanh</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <button class="quick-add-btn bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-gray-100 transition" data-description="Cafe" data-amount="25000" data-category="ƒÇn u·ªëng" data-source="cash">‚òï Cafe 25k</button>
                <button class="quick-add-btn bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-gray-100 transition" data-description="ƒÇn s√°ng" data-amount="30000" data-category="ƒÇn u·ªëng" data-source="cash">üçú ƒÇn s√°ng 30k</button>
                <button class="quick-add-btn bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-gray-100 transition" data-description="ƒê·ªï xƒÉng" data-amount="50000" data-category="Di chuy·ªÉn" data-source="cash">‚õΩ ƒê·ªï xƒÉng 50k</button>
                <button class="quick-add-btn bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-gray-100 transition" data-description="G·ª≠i xe" data-amount="5000" data-category="Di chuy·ªÉn" data-source="cash">üÖøÔ∏è G·ª≠i xe 5k</button>
            </div>
        </section>

        <!-- ACTION BUTTONS -->
        <section class="flex justify-center gap-4 mb-6">
             <button id="open-ai-modal-btn" class="flex-1 bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-200 flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 01-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 013.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 013.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 01-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.624L16.5 21.75l-.398-1.126a3.375 3.375 0 00-2.456-2.456L12.75 18l1.126-.398a3.375 3.375 0 002.456-2.456L16.5 14.25l.398 1.126a3.375 3.375 0 002.456 2.456L20.25 18l-1.126.398a3.375 3.375 0 00-2.456 2.456z" /></svg>
                Nh·∫≠p b·∫±ng AI
            </button>
            <button id="open-add-modal-btn" class="flex-1 bg-gray-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75 transition duration-200 flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                Th√™m th·ªß c√¥ng
            </button>
        </section>

        <!-- TRANSACTIONS LIST -->
        <section>
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Giao d·ªãch g·∫ßn ƒë√¢y</h2>
            <div id="transactions-list" class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                <p id="no-transactions-msg" class="text-center text-gray-500 p-8">Ch∆∞a c√≥ giao d·ªãch n√†o.</p>
            </div>
        </section>
        
        <div id="user-info" class="text-center mt-6 text-xs text-gray-400 break-all p-2 rounded-lg bg-gray-100">
            ƒêang t·∫£i User ID...
        </div>
    </div>

    <!-- ADD/EDIT TRANSACTION MODAL - UPDATED -->
    <div id="add-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-6 transform scale-95 opacity-0">
            <h2 class="text-xl font-bold mb-4">Th√™m Giao D·ªãch M·ªõi</h2>
            <form id="add-form">
                <div class="mb-4">
                    <label for="type" class="block text-sm font-medium text-gray-700 mb-1">Lo·∫°i giao d·ªãch</label>
                    <select id="type" name="type" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="expense">Chi Ti√™u</option>
                        <option value="income">Thu Nh·∫≠p</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1">M√¥ t·∫£</label>
                    <input type="text" id="description" name="description" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">S·ªë ti·ªÅn (‚Ç´)</label>
                    <input type="number" id="amount" name="amount" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="source" class="block text-sm font-medium text-gray-700 mb-1">Ngu·ªìn ti·ªÅn</label>
                    <select id="source" name="source" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="bank">T√†i kho·∫£n</option>
                        <option value="cash">Ti·ªÅn m·∫∑t</option>
                    </select>
                </div>
                 <div class="mb-6">
                    <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Danh m·ª•c</label>
                    <input type="text" id="category" name="category" list="categories" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="VD: ƒÇn u·ªëng, Di chuy·ªÉn...">
                    <datalist id="categories">
                        <option value="ƒÇn u·ªëng">
                        <option value="Di chuy·ªÉn">
                        <option value="Mua s·∫Øm">
                        <option value="H√≥a ƒë∆°n">
                        <option value="Gi·∫£i tr√≠">
                        <option value="L∆∞∆°ng">
                        <option value="Kh√°c">
                    </datalist>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-add-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">H·ªßy</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">L∆∞u</button>
                </div>
            </form>
        </div>
    </div>

    <!-- AI IMPORT MODAL -->
    <div id="ai-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-6 transform scale-95 opacity-0">
            <h2 class="text-xl font-bold mb-2">Nh·∫≠p li·ªáu b·∫±ng AI</h2>
            <p class="text-sm text-gray-500 mb-4">Nh·∫≠p y√™u c·∫ßu b·∫±ng ng√¥n ng·ªØ t·ª± nhi√™n ho·∫∑c d√°n n·ªôi dung tin nh·∫Øn v√†o ƒë√¢y.</p>
            <form id="ai-form">
                <textarea id="ai-input" rows="6" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="V√≠ d·ª•: chi 50k ti·ªÅn m·∫∑t u·ªëng cafe, ho·∫∑c d√°n n·ªôi dung SMS t·ª´ ng√¢n h√†ng..."></textarea>
                <div id="ai-status" class="text-sm text-yellow-600 mt-2 h-5"></div>
                <div class="flex justify-end gap-4 mt-4">
                    <button type="button" id="cancel-ai-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">H·ªßy</bitton>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 flex items-center justify-center gap-2">
                        <span id="ai-submit-text">X·ª≠ l√Ω</span>
                        <svg id="ai-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-900 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 translate-y-10 transition-all duration-300">
        <p id="toast-message"></p>
    </div>

    <script>
        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
    <script type="module">
        // Import c√°c h√†m c·∫ßn thi·∫øt t·ª´ Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIG & INITIALIZATION ---
        
        // C·∫§U H√åNH FIREBASE ƒê√É ƒê∆Ø·ª¢C T·ª∞ ƒê·ªòNG C·∫¨P NH·∫¨T
        const firebaseConfig = {
          apiKey: "AIzaSyDY-LHMVcRN_mRuxSmO-4fTcQoMQvxaMRE",
          authDomain: "do12341.firebaseapp.com",
          projectId: "do12341",
          storageBucket: "do12341.appspot.com",
          messagingSenderId: "727920669744",
          appId: "1:727920669744:web:7e9c43d26626083d6969f5",
          measurementId: "G-V7RMVF8JDM"
        };

        // GEMINI API KEY ƒê√É ƒê∆Ø·ª¢C C·∫¨P NH·∫¨T
        const geminiApiKey = "AIzaSyAs0QDCxzbipEe-cL5bVkvJS3XbslAB0Ug";
        
        let db, auth, userId, transactionsUnsubscribe;

        // --- UI ELEMENTS ---
        const mainContainer = document.getElementById('main-container');
        const authErrorOverlay = document.getElementById('auth-error-overlay');
        const geminiErrorOverlay = document.getElementById('gemini-error-overlay');
        const totalIncomeEl = document.getElementById('total-income');
        const totalExpenseEl = document.getElementById('total-expense');
        const cashBalanceEl = document.getElementById('cash-balance');
        const bankBalanceEl = document.getElementById('bank-balance');
        const transactionsListEl = document.getElementById('transactions-list');
        const noTransactionsMsg = document.getElementById('no-transactions-msg');
        const userInfoEl = document.getElementById('user-info');
        const aiSubmitBtn = document.querySelector('#ai-form button[type="submit"]');
        const aiSubmitText = document.getElementById('ai-submit-text');
        const aiSpinner = document.getElementById('ai-spinner');

        // Modals
        const addModal = document.getElementById('add-modal');
        const aiModal = document.getElementById('ai-modal');
        const addForm = document.getElementById('add-form');
        const aiForm = document.getElementById('ai-form');

        // Toast
        const toastEl = document.getElementById('toast');
        const toastMessageEl = document.getElementById('toast-message');

        // --- HELPER FUNCTIONS ---
        function showToast(message, duration = 3000) {
            toastMessageEl.textContent = message;
            toastEl.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => {
                toastEl.classList.add('opacity-0', 'translate-y-10');
            }, duration);
        }
        
        function formatCurrency(num) {
            if (typeof num !== 'number') return '0 ‚Ç´';
            return num.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
        }

        function toggleModal(modal, show) {
            const content = modal.querySelector('.modal-content');
            if (show) {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('bg-opacity-0');
                    if (content) content.classList.remove('scale-95', 'opacity-0');
                }, 10);
            } else {
                modal.classList.add('bg-opacity-0');
                if (content) content.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
        }

        // --- RENDER FUNCTIONS ---
        function renderTransactions(transactions) {
            transactionsListEl.innerHTML = ''; 
            if (transactions.length === 0) {
                if(noTransactionsMsg) {
                    transactionsListEl.appendChild(noTransactionsMsg);
                    noTransactionsMsg.style.display = 'block';
                }
                return;
            }
            if(noTransactionsMsg) noTransactionsMsg.style.display = 'none';

            const sortedTransactions = transactions.sort((a, b) => {
                const dateA = a.createdAt?.toDate() || new Date(0);
                const dateB = b.createdAt?.toDate() || new Date(0);
                return dateB - dateA;
            });

            sortedTransactions.forEach(t => {
                const isExpense = t.type === 'expense';
                const sign = isExpense ? '-' : '+';
                const amountColor = isExpense ? 'text-red-500' : 'text-green-500';
                const date = t.createdAt?.toDate() ? t.createdAt.toDate().toLocaleDateString('vi-VN') : 'Kh√¥ng c√≥ ng√†y';
                const sourceText = t.source === 'cash' ? 'Ti·ªÅn m·∫∑t' : 'T√†i kho·∫£n';
                const sourceColor = t.source === 'cash' ? 'bg-blue-100 text-blue-800' : 'bg-indigo-100 text-indigo-800';

                const item = document.createElement('div');
                item.className = 'transaction-item flex items-center justify-between p-4 border-b border-gray-100';
                item.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center ${isExpense ? 'bg-red-100' : 'bg-green-100'}">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 ${amountColor}">
                              <path stroke-linecap="round" stroke-linejoin="round" d="${isExpense ? 'M2.25 18L9 11.25l4.328 4.329 7.09-7.091M2.25 12.75h7.5m7.5 7.5h-7.5' : 'M2.25 6L9 12.75l4.328-4.329 7.09 7.091M2.25 11.25h7.5m7.5-7.5h-7.5'}" />
                            </svg>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-800">${t.description}</p>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-xs px-2 py-0.5 rounded-full ${sourceColor}">${sourceText}</span>
                                <p class="text-sm text-gray-500">${t.category || 'Ch∆∞a ph√¢n lo·∫°i'} ¬∑ ${date}</p>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold ${amountColor}">${sign}${formatCurrency(t.amount)}</p>
                        <button data-id="${t.id}" class="delete-btn text-xs text-gray-400 hover:text-red-500 mt-1">X√≥a</button>
                    </div>
                `;
                transactionsListEl.appendChild(item);
            });
        }

        // UPDATED SUMMARY FUNCTION
        function updateSummary(transactions) {
            let totalIncome = 0;
            let totalExpense = 0;
            let cashBalance = 0;
            let bankBalance = 0;

            transactions.forEach(t => {
                if (t.type === 'income') {
                    totalIncome += t.amount;
                    if (t.source === 'cash') {
                        cashBalance += t.amount;
                    } else { // 'bank' or default
                        bankBalance += t.amount;
                    }
                } else { // 'expense'
                    totalExpense += t.amount;
                    if (t.source === 'cash') {
                        cashBalance -= t.amount;
                    } else { // 'bank' or default
                        bankBalance -= t.amount;
                    }
                }
            });

            totalIncomeEl.textContent = formatCurrency(totalIncome);
            totalExpenseEl.textContent = formatCurrency(totalExpense);
            cashBalanceEl.textContent = formatCurrency(cashBalance);
            bankBalanceEl.textContent = formatCurrency(bankBalance);
        }

        // --- FIRESTORE LOGIC ---
        function getTransactions() {
            if (transactionsUnsubscribe) transactionsUnsubscribe();
            if (!userId) return;

            const transactionsCol = collection(db, `users/${userId}/transactions`);
            const q = query(transactionsCol);

            transactionsUnsubscribe = onSnapshot(q, (querySnapshot) => {
                const transactions = [];
                querySnapshot.forEach((doc) => {
                    transactions.push({ id: doc.id, ...doc.data() });
                });
                renderTransactions(transactions);
                updateSummary(transactions);
            }, (error) => {
                console.error("L·ªói khi l·∫•y d·ªØ li·ªáu: ", error);
                showToast("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.");
            });
        }

        async function addTransaction(data) {
            if (!userId) {
                showToast("L·ªói: Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng.");
                return false;
            }
            try {
                const transactionsCol = collection(db, `users/${userId}/transactions`);
                await addDoc(transactionsCol, {
                    ...data,
                    createdAt: serverTimestamp()
                });
                showToast("ƒê√£ th√™m giao d·ªãch th√†nh c√¥ng!");
                return true;
            } catch (error) {
                console.error("L·ªói khi th√™m giao d·ªãch: ", error);
                showToast("Th√™m giao d·ªãch th·∫•t b·∫°i.");
                return false;
            }
        }

        async function deleteTransaction(id) {
            if (!window.confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a giao d·ªãch n√†y?')) return;
            try {
                const docRef = doc(db, `users/${userId}/transactions`, id);
                await deleteDoc(docRef);
                showToast("ƒê√£ x√≥a giao d·ªãch.");
            } catch (error) {
                console.error("L·ªói khi x√≥a giao d·ªãch: ", error);
                showToast("X√≥a giao d·ªãch th·∫•t b·∫°i.");
            }
        }
        
        function setAISubmitButtonLoading(isLoading) {
            if (isLoading) {
                aiSubmitBtn.disabled = true;
                aiSubmitText.classList.add('hidden');
                aiSpinner.classList.remove('hidden');
            } else {
                aiSubmitBtn.disabled = false;
                aiSubmitText.classList.remove('hidden');
                aiSpinner.classList.add('hidden');
            }
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            document.getElementById('open-add-modal-btn').addEventListener('click', () => toggleModal(addModal, true));
            document.getElementById('open-ai-modal-btn').addEventListener('click', () => {
                if (geminiApiKey === "YOUR_GEMINI_API_KEY") {
                    mainContainer.style.display = 'none';
                    authErrorOverlay.style.display = 'none'; // Hide other errors
                    geminiErrorOverlay.classList.remove('hidden');
                    return;
                }
                toggleModal(aiModal, true)
            });

            // NEW: Quick Add Buttons Listener
            document.getElementById('quick-add-section').addEventListener('click', (e) => {
                const button = e.target.closest('.quick-add-btn');
                if (button) {
                    const transactionData = {
                        description: button.dataset.description,
                        amount: parseFloat(button.dataset.amount),
                        category: button.dataset.category,
                        source: button.dataset.source,
                        type: 'expense' // Quick adds are always expenses
                    };
                    addTransaction(transactionData);
                }
            });

            document.getElementById('cancel-add-btn').addEventListener('click', () => toggleModal(addModal, false));
            document.getElementById('cancel-ai-btn').addEventListener('click', () => toggleModal(aiModal, false));
            addModal.addEventListener('click', (e) => { if (e.target.id === 'add-modal') toggleModal(addModal, false); });
            aiModal.addEventListener('click', (e) => { if (e.target.id === 'ai-modal') toggleModal(aiModal, false); });

            // UPDATED ADD FORM
            addForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const success = await addTransaction({
                    type: addForm.type.value,
                    description: addForm.description.value,
                    amount: parseFloat(addForm.amount.value),
                    source: addForm.source.value, // Added source
                    category: addForm.category.value
                });
                if (success) {
                    addForm.reset();
                    toggleModal(addModal, false);
                }
            });

            // UPDATED AI FORM
            aiForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userInput = document.getElementById('ai-input').value;
                const statusEl = document.getElementById('ai-status');
                if (!userInput.trim()) {
                    statusEl.textContent = "Vui l√≤ng nh·∫≠p n·ªôi dung.";
                    return;
                }
                statusEl.textContent = "AI ƒëang ph√¢n t√≠ch...";
                setAISubmitButtonLoading(true);

                try {
                    const prompt = `B·∫°n l√† m·ªôt tr·ª£ l√Ω t√†i ch√≠nh chuy√™n nghi·ªáp. Ph√¢n t√≠ch vƒÉn b·∫£n ti·∫øng Vi·ªát sau ƒë√¢y v√† tr√≠ch xu·∫•t chi ti·∫øt giao d·ªãch.
                    VƒÉn b·∫£n: "${userInput}"
                    
                    H√£y tr·∫£ v·ªÅ k·∫øt qu·∫£ CH·ªà L√Ä m·ªôt ƒë·ªëi t∆∞·ª£ng JSON, kh√¥ng c√≥ b·∫•t k·ª≥ vƒÉn b·∫£n gi·∫£i th√≠ch hay ƒë·ªãnh d·∫°ng markdown n√†o.
                    ƒê·ªëi t∆∞·ª£ng JSON ph·∫£i c√≥ c√°c tr∆∞·ªùng sau: "amount" (NUMBER), "description" (STRING), "type" ('income' ho·∫∑c 'expense'), "category" (STRING), v√† "source" ('cash' ho·∫∑c 'bank').
                    - Chuy·ªÉn ƒë·ªïi c√°c gi√° tr·ªã nh∆∞ 'k' th√†nh '000' v√† 'tr' th√†nh '000000'.
                    - 'type' ph·∫£i l√† 'expense' ho·∫∑c 'income'.
                    - 'category' n√™n ƒë∆∞·ª£c suy ra t·ª´ m√¥ t·∫£.
                    - 'source' ph·∫£i l√† 'cash' n·∫øu vƒÉn b·∫£n ch·ª©a t·ª´ "ti·ªÅn m·∫∑t". N·∫øu kh√¥ng, ho·∫∑c n·∫øu n√≥ ƒë·ªÅ c·∫≠p ƒë·∫øn ng√¢n h√†ng/th·∫ª, h√£y m·∫∑c ƒë·ªãnh l√† 'bank'.
                    - 'description' ph·∫£i m√¥ t·∫£ ng·∫Øn g·ªçn giao d·ªãch.`;

                    const payload = {
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                    };

                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`API call failed with status: ${response.status}. Body: ${errorBody}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                        let jsonText = result.candidates[0].content.parts[0].text;
                        
                        const jsonMatch = jsonText.match(/```(json)?\s*([\s\S]*?)\s*```/);
                        if (jsonMatch && jsonMatch[2]) {
                            jsonText = jsonMatch[2];
                        }

                        const parsedData = JSON.parse(jsonText);

                        const success = await addTransaction(parsedData);
                        if (success) {
                            aiForm.reset();
                            statusEl.textContent = "";
                            toggleModal(aiModal, false);
                        } else {
                            statusEl.textContent = "ƒê√£ x·∫£y ra l·ªói khi l∆∞u.";
                        }
                    } else {
                         throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi h·ª£p l·ªá t·ª´ AI. Ph·∫£n h·ªìi: " + JSON.stringify(result));
                    }

                } catch (error) {
                    console.error("L·ªói khi g·ªçi AI:", error);
                    statusEl.textContent = "AI kh√¥ng th·ªÉ x·ª≠ l√Ω y√™u c·∫ßu n√†y.";
                    showToast("L·ªói AI: " + error.message, 5000);
                } finally {
                    setAISubmitButtonLoading(false);
                }
            });

            transactionsListEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const id = e.target.dataset.id;
                    deleteTransaction(id);
                }
            });
        }

        // --- INITIALIZATION ---
        async function main() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userInfoEl.textContent = `User ID: ${userId}`;
                        getTransactions();
                    } else {
                        signInAnonymously(auth).catch(error => {
                            console.error("L·ªói ƒëƒÉng nh·∫≠p ·∫©n danh:", error);
                            // Check for the specific error code for disabled anonymous auth
                            if (error.code === 'auth/operation-not-allowed' || error.code === 'auth/admin-restricted-operation') {
                                mainContainer.style.display = 'none';
                                authErrorOverlay.classList.remove('hidden');
                            } else {
                                userInfoEl.textContent = "Kh√¥ng th·ªÉ x√°c th·ª±c ng∆∞·ªùi d√πng.";
                                showToast("L·ªói x√°c th·ª±c: " + error.message, 5000);
                            }
                        });
                    }
                });

                setupEventListeners();
            } catch(e) {
                console.error("L·ªói kh·ªüi t·∫°o Firebase: ", e);
                // Fallback for any other initialization error
                mainContainer.innerHTML = `<div class="p-6 text-center"><h1 class="text-2xl font-bold text-red-600">L·ªói Kh·ªüi T·∫°o Nghi√™m Tr·ªçng</h1><p>${e.message}</p></div>`;
            }
        }

        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>
