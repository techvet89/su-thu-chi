import React, { useState, useEffect, createContext, useContext, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp } from 'firebase/firestore';

// Tạo Context cho Firebase và User
const AppContext = createContext(null);

// Modal xác nhận tùy chỉnh
const ConfirmationModal = ({ message, onConfirm, onCancel }) => {
    return (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
            <div className="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                <p className="text-lg font-semibold mb-4">{message}</p>
                <div className="flex justify-end space-x-3">
                    <button
                        onClick={onCancel}
                        className="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors duration-200"
                    >
                        Hủy
                    </button>
                    <button
                        onClick={onConfirm}
                        className="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors duration-200"
                    >
                        Xác nhận
                    </button>
                </div>
            </div>
        </div>
    );
};

const App = () => {
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [currentPage, setCurrentPage] = useState('dashboard');
    const [message, setMessage] = useState('');
    const [showMessage, setShowMessage] = useState(false);
    const [showConfirmModal, setShowConfirmModal] = useState(false);
    const [confirmAction, setConfirmAction] = useState(null);
    const [confirmMessage, setConfirmMessage] = useState('');

    // Hàm hiển thị thông báo
    const showAppMessage = (msg, duration = 3000) => {
        setMessage(msg);
        setShowMessage(true);
        setTimeout(() => {
            setShowMessage(false);
            setMessage('');
        }, duration);
    };

    // Hàm hiển thị modal xác nhận
    const showConfirmation = (msg, action) => {
        setConfirmMessage(msg);
        setConfirmAction(() => action); // Lưu hành động để thực thi khi xác nhận
        setShowConfirmModal(true);
    };

    const handleConfirm = () => {
        if (confirmAction) {
            confirmAction();
        }
        setShowConfirmModal(false);
        setConfirmAction(null);
        setConfirmMessage('');
    };

    const handleCancelConfirm = () => {
        setShowConfirmModal(false);
        setConfirmAction(null);
        setConfirmMessage('');
    };

    useEffect(() => {
        try {
            // Lấy cấu hình Firebase và App ID từ biến toàn cục
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            // Khởi tạo Firebase
            const app = initializeApp(firebaseConfig);
            const firestoreDb = getFirestore(app);
            const firebaseAuth = getAuth(app);

            setDb(firestoreDb);
            setAuth(firebaseAuth);

            // Lắng nghe trạng thái xác thực
            const unsubscribe = onAuthStateChanged(firebaseAuth, async (user) => {
                if (user) {
                    setUserId(user.uid);
                    setIsAuthReady(true);
                } else {
                    // Nếu không có người dùng, thử đăng nhập bằng token hoặc ẩn danh
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (initialAuthToken) {
                        try {
                            await signInWithCustomToken(firebaseAuth, initialAuthToken);
                        } catch (error) {
                            console.error("Lỗi khi đăng nhập bằng token tùy chỉnh:", error);
                            await signInAnonymously(firebaseAuth);
                        }
                    } else {
                        await signInAnonymously(firebaseAuth);
                    }
                }
            });

            // Dọn dẹp listener khi component unmount
            return () => unsubscribe();
        } catch (error) {
            console.error("Lỗi khi khởi tạo Firebase:", error);
            showAppMessage("Lỗi khi khởi tạo ứng dụng. Vui lòng thử lại.", 5000);
        }
    }, []);

    if (!isAuthReady) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-gray-100">
                <div className="text-xl font-semibold text-gray-700">Đang tải ứng dụng...</div>
            </div>
        );
    }

    return (
        <AppContext.Provider value={{ db, auth, userId, showAppMessage, showConfirmation }}>
            <div className="flex flex-col md:flex-row min-h-screen bg-gray-100 font-inter">
                {/* Thanh điều hướng bên trái */}
                <aside className="w-full md:w-64 bg-gradient-to-br from-blue-600 to-blue-800 text-white shadow-lg rounded-br-lg rounded-bl-lg md:rounded-tr-none md:rounded-bl-none md:rounded-br-lg">
                    <div className="p-6">
                        <h1 className="text-3xl font-bold mb-6 text-center">Ngô Văn Đô</h1>
                        <p className="text-sm text-center opacity-80 mb-8">Tài chính & Bán hàng</p>
                        <nav>
                            <ul>
                                {['dashboard', 'products', 'orders', 'customers', 'finance', 'reports', 'ai_chat'].map((item) => (
                                    <li key={item} className="mb-3">
                                        <button
                                            onClick={() => setCurrentPage(item)}
                                            className={`flex items-center w-full py-3 px-4 rounded-lg transition-all duration-200 ease-in-out
                                                ${currentPage === item ? 'bg-blue-700 shadow-md transform scale-105' : 'hover:bg-blue-700 hover:shadow-md'}`}
                                        >
                                            {item === 'dashboard' && <i className="fas fa-th-large mr-3"></i>}
                                            {item === 'products' && <i className="fas fa-box-open mr-3"></i>}
                                            {item === 'orders' && <i className="fas fa-shopping-cart mr-3"></i>}
                                            {item === 'customers' && <i className="fas fa-users mr-3"></i>}
                                            {item === 'finance' && <i className="fas fa-wallet mr-3"></i>}
                                            {item === 'reports' && <i className="fas fa-chart-line mr-3"></i>}
                                            {item === 'ai_chat' && <i className="fas fa-robot mr-3"></i>}
                                            <span className="capitalize">{item === 'dashboard' ? 'Bảng điều khiển' : item === 'products' ? 'Sản phẩm' : item === 'orders' ? 'Đơn hàng' : item === 'customers' ? 'Khách hàng' : item === 'finance' ? 'Tài chính' : item === 'reports' ? 'Báo cáo' : 'AI Chat'}</span>
                                        </button>
                                    </li>
                                ))}
                            </ul>
                        </nav>
                    </div>
                </aside>

                {/* Nội dung chính */}
                <main className="flex-1 p-6 md:p-8 bg-gray-50 rounded-tl-lg md:rounded-tl-none md:rounded-tr-lg shadow-inner">
                    <header className="flex flex-col sm:flex-row justify-between items-center mb-6 pb-4 border-b border-gray-200">
                        <h2 className="text-3xl font-bold text-gray-800 mb-4 sm:mb-0">
                            {currentPage === 'dashboard' ? 'Bảng điều khiển' : currentPage === 'products' ? 'Sản phẩm' : currentPage === 'orders' ? 'Đơn hàng' : currentPage === 'customers' ? 'Khách hàng' : currentPage === 'finance' ? 'Tài chính' : currentPage === 'reports' ? 'Báo cáo' : 'AI Chat'}
                        </h2>
                        <div className="flex items-center space-x-4">
                            <span className="text-gray-600 text-sm">User ID: {userId}</span>
                            <div className="relative">
                                <img src={`https://placehold.co/40x40/ADD8E6/000000?text=NV`} alt="User Avatar" className="w-10 h-10 rounded-full border-2 border-blue-500 shadow-md" />
                                <span className="absolute bottom-0 right-0 block h-3 w-3 rounded-full ring-2 ring-white bg-green-400"></span>
                            </div>
                        </div>
                    </header>

                    {/* Hiển thị thông báo */}
                    {showMessage && (
                        <div className="fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in-down">
                            {message}
                        </div>
                    )}

                    {/* Modal xác nhận */}
                    {showConfirmModal && (
                        <ConfirmationModal
                            message={confirmMessage}
                            onConfirm={handleConfirm}
                            onCancel={handleCancelConfirm}
                        />
                    )}

                    {/* Render component dựa trên currentPage */}
                    {currentPage === 'dashboard' && <Dashboard />}
                    {currentPage === 'products' && <Products />}
                    {currentPage === 'orders' && <Orders />}
                    {currentPage === 'customers' && <Customers />}
                    {currentPage === 'finance' && <Finance />}
                    {currentPage === 'ai_chat' && <AIChat />}
                    {currentPage === 'reports' && <Reports />}
                </main>
            </div>
        </AppContext.Provider>
    );
};

// Component Bảng điều khiển (Dashboard)
const Dashboard = () => {
    const { db, userId, showAppMessage } = useContext(AppContext);
    const [totalInventoryValue, setTotalInventoryValue] = useState(0);
    const [totalRevenue, setTotalRevenue] = useState(0);
    const [accountsReceivable, setAccountsReceivable] = useState(0);
    const [totalAssets, setTotalAssets] = useState(0);
    const [incomeVsExpense, setIncomeVsExpense] = useState({ income: 0, expense: 0 });

    useEffect(() => {
        if (!db || !userId) return;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const userFinanceCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/finance`);
        const userProductsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/products`);
        const userOrdersCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/orders`);

        // Lắng nghe thay đổi dữ liệu tài chính
        const unsubscribeFinance = onSnapshot(userFinanceCollectionRef, (snapshot) => {
            let totalIncome = 0;
            let totalExpense = 0;
            snapshot.forEach((doc) => {
                const data = doc.data();
                if (data.type === 'income') {
                    totalIncome += data.amount;
                } else if (data.type === 'expense') {
                    totalExpense += data.amount;
                }
            });
            setIncomeVsExpense({ income: totalIncome, expense: totalExpense });
            setTotalAssets(totalIncome - totalExpense); // Tạm tính tổng tài sản là thu nhập ròng
        }, (error) => {
            console.error("Lỗi khi lấy dữ liệu tài chính:", error);
            showAppMessage("Không thể tải dữ liệu tài chính.", 5000);
        });

        // Lắng nghe thay đổi dữ liệu sản phẩm để tính tổng giá trị kho
        const unsubscribeProducts = onSnapshot(userProductsCollectionRef, (snapshot) => {
            let inventoryValue = 0;
            snapshot.forEach((doc) => {
                const data = doc.data();
                inventoryValue += (data.price || 0) * (data.stock || 0);
            });
            setTotalInventoryValue(inventoryValue);
        }, (error) => {
            console.error("Lỗi khi lấy dữ liệu sản phẩm:", error);
            showAppMessage("Không thể tải dữ liệu sản phẩm.", 5000);
        });

        // Lắng nghe thay đổi dữ liệu đơn hàng để tính tổng doanh thu và công nợ phải thu
        const unsubscribeOrders = onSnapshot(userOrdersCollectionRef, (snapshot) => {
            let revenue = 0;
            let receivable = 0;
            snapshot.forEach((doc) => {
                const data = doc.data();
                revenue += data.totalAmount || 0;
                if (data.status === 'pending_payment' || data.status === 'partially_paid') {
                    receivable += (data.totalAmount || 0) - (data.paidAmount || 0);
                }
            });
            setTotalRevenue(revenue);
            setAccountsReceivable(receivable);
        }, (error) => {
            console.error("Lỗi khi lấy dữ liệu đơn hàng:", error);
            showAppMessage("Không thể tải dữ liệu đơn hàng.", 5000);
        });


        return () => {
            unsubscribeFinance();
            unsubscribeProducts();
            unsubscribeOrders();
        };
    }, [db, userId, showAppMessage]);

    const formatCurrency = (amount) => {
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
    };

    return (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <DashboardCard title="Tổng giá trị kho" value={formatCurrency(totalInventoryValue)} icon="fas fa-box" color="bg-purple-500" />
            <DashboardCard title="Tổng doanh thu" value={formatCurrency(totalRevenue)} icon="fas fa-chart-line" color="bg-green-500" />
            <DashboardCard title="Công nợ phải thu" value={formatCurrency(accountsReceivable)} icon="fas fa-hand-holding-usd" color="bg-red-500" />
            <DashboardCard title="Tổng tài sản" value={formatCurrency(totalAssets)} icon="fas fa-piggy-bank" color="bg-blue-500" />

            <div className="lg:col-span-2 bg-white p-6 rounded-lg shadow-md flex flex-col justify-between">
                <div>
                    <h3 className="text-xl font-semibold text-gray-700 mb-4">Thu vs Chi</h3>
                    <div className="flex items-center justify-between mb-2">
                        <span className="text-green-600 font-medium">Thu nhập: {formatCurrency(incomeVsExpense.income)}</span>
                        <span className="text-red-600 font-medium">Chi phí: {formatCurrency(incomeVsExpense.expense)}</span>
                    </div>
                    <div className="w-full bg-gray-200 rounded-full h-4 relative overflow-hidden">
                        <div
                            className="bg-green-500 h-4 rounded-full absolute top-0 left-0 transition-all duration-500 ease-out"
                            style={{ width: `${(incomeVsExpense.income / (incomeVsExpense.income + incomeVsExpense.expense)) * 100 || 0}%` }}
                        ></div>
                        <div
                            className="bg-red-500 h-4 rounded-full absolute top-0 right-0 transition-all duration-500 ease-out"
                            style={{ width: `${(incomeVsExpense.expense / (incomeVsExpense.income + incomeVsExpense.expense)) * 100 || 0}%` }}
                        ></div>
                    </div>
                </div>
                <p className="text-sm text-gray-500 mt-4">Biểu đồ thu chi (đơn giản).</p>
            </div>

            <div className="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                <h3 className="text-xl font-semibold text-gray-700 mb-4">Cơ cấu tài sản</h3>
                <div className="flex items-center justify-center h-48">
                    <p className="text-gray-500">Biểu đồ cơ cấu tài sản sẽ hiển thị tại đây.</p>
                </div>
            </div>
        </div>
    );
};

// Component thẻ Dashboard
const DashboardCard = ({ title, value, icon, color }) => (
    <div className={`${color} text-white p-6 rounded-lg shadow-md flex flex-col justify-between transform transition-transform duration-300 hover:scale-105`}>
        <div className="flex items-center justify-between mb-4">
            <h3 className="text-lg font-medium">{title}</h3>
            <i className={`${icon} text-3xl opacity-75`}></i>
        </div>
        <p className="text-4xl font-bold">{value}</p>
    </div>
);

// Component Sản phẩm (Products)
const Products = () => {
    const { db, userId, showAppMessage, showConfirmation } = useContext(AppContext);
    const [products, setProducts] = useState([]);
    const [newProduct, setNewProduct] = useState({ name: '', price: '', stock: '' });
    const [editingProduct, setEditingProduct] = useState(null);

    useEffect(() => {
        if (!db || !userId) return;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const productsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/products`);

        const unsubscribe = onSnapshot(productsCollectionRef, (snapshot) => {
            const productsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setProducts(productsData);
        }, (error) => {
            console.error("Lỗi khi lấy dữ liệu sản phẩm:", error);
            showAppMessage("Không thể tải dữ liệu sản phẩm.", 5000);
        });

        return () => unsubscribe();
    }, [db, userId, showAppMessage]);

    const handleAddProduct = async () => {
        if (!newProduct.name || !newProduct.price || !newProduct.stock) {
            showAppMessage("Vui lòng điền đầy đủ thông tin sản phẩm.", 3000);
            return;
        }
        if (isNaN(newProduct.price) || isNaN(newProduct.stock) || parseFloat(newProduct.price) < 0 || parseInt(newProduct.stock) < 0) {
            showAppMessage("Giá và số lượng phải là số không âm.", 3000);
            return;
        }

        try {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            await addDoc(collection(db, `artifacts/${appId}/users/${userId}/products`), {
                name: newProduct.name,
                price: parseFloat(newProduct.price),
                stock: parseInt(newProduct.stock),
                createdAt: serverTimestamp()
            });
            setNewProduct({ name: '', price: '', stock: '' });
            showAppMessage("Sản phẩm đã được thêm thành công!");
        } catch (e) {
            console.error("Lỗi khi thêm sản phẩm: ", e);
            showAppMessage("Lỗi khi thêm sản phẩm.", 5000);
        }
    };

    const handleUpdateProduct = async () => {
        if (!editingProduct.name || !editingProduct.price || !editingProduct.stock) {
            showAppMessage("Vui lòng điền đầy đủ thông tin sản phẩm.", 3000);
            return;
        }
        if (isNaN(editingProduct.price) || isNaN(editingProduct.stock) || parseFloat(editingProduct.price) < 0 || parseInt(editingProduct.stock) < 0) {
            showAppMessage("Giá và số lượng phải là số không âm.", 3000);
            return;
        }

        try {
            const appId = typeof __app_id !== 'undefined' ? __app_id :'default-app-id';
            const productRef = doc(db, `artifacts/${appId}/users/${userId}/products`, editingProduct.id);
            await updateDoc(productRef, {
                name: editingProduct.name,
                price: parseFloat(editingProduct.price),
                stock: parseInt(editingProduct.stock),
                updatedAt: serverTimestamp()
            });
            setEditingProduct(null);
            showAppMessage("Sản phẩm đã được cập nhật thành công!");
        } catch (e) {
            console.error("Lỗi khi cập nhật sản phẩm: ", e);
            showAppMessage("Lỗi khi cập nhật sản phẩm.", 5000);
        }
    };

    const handleDeleteProduct = async (id) => {
        showConfirmation("Bạn có chắc chắn muốn xóa sản phẩm này?", async () => {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/products`, id));
                showAppMessage("Sản phẩm đã được xóa thành công!");
            } catch (e) {
                console.error("Lỗi khi xóa sản phẩm: ", e);
                showAppMessage("Lỗi khi xóa sản phẩm.", 5000);
            }
        });
    };

    const formatCurrency = (amount) => {
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
    };

    return (
        <div className="bg-white p-6 rounded-lg shadow-md">
            <h3 className="text-xl font-semibold text-gray-700 mb-4">Quản lý Sản phẩm</h3>

            <div className="mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                <h4 className="text-lg font-medium text-gray-700 mb-3">{editingProduct ? 'Chỉnh sửa Sản phẩm' : 'Thêm Sản phẩm mới'}</h4>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <input
                        type="text"
                        placeholder="Tên sản phẩm"
                        className="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        value={editingProduct ? editingProduct.name : newProduct.name}
                        onChange={(e) => editingProduct ? setEditingProduct({ ...editingProduct, name: e.target.value }) : setNewProduct({ ...newProduct, name: e.target.value })}
                    />
                    <input
                        type="number"
                        placeholder="Giá"
                        className="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        value={editingProduct ? editingProduct.price : newProduct.price}
                        onChange={(e) => editingProduct ? setEditingProduct({ ...editingProduct, price: e.target.value }) : setNewProduct({ ...newProduct, price: e.target.value })}
                    />
                    <input
                        type="number"
                        placeholder="Số lượng tồn kho"
                        className="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        value={editingProduct ? editingProduct.stock : newProduct.stock}
                        onChange={(e) => editingProduct ? setEditingProduct({ ...editingProduct, stock: e.target.value }) : setNewProduct({ ...newProduct, stock: e.target.value })}
                    />
                </div>
                {editingProduct ? (
                    <div className="flex space-x-2">
                        <button
                            onClick={handleUpdateProduct}
                            className="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition-colors duration-200"
                        >
                            Cập nhật Sản phẩm
                        </button>
                        <button
                            onClick={() => setEditingProduct(null)}
                            className="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition-colors duration-200"
                        >
                            Hủy
                        </button>
                    </div>
                ) : (
                    <button
                        onClick={handleAddProduct}
                        className="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors duration-200"
                    >
                        Thêm Sản phẩm
                    </button>
                )}
            </div>

            <div className="overflow-x-auto">
                <table className="min-w-full bg-white rounded-lg shadow-sm">
                    <thead>
                        <tr className="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                            <th className="py-3 px-6 text-left">Tên sản phẩm</th>
                            <th className="py-3 px-6 text-left">Giá</th>
                            <th className="py-3 px-6 text-left">Tồn kho</th>
                            <th className="py-3 px-6 text-center">Hành động</th>
                        </tr>
                    </thead>
                    <tbody className="text-gray-600 text-sm font-light">
                        {products.length === 0 ? (
                            <tr>
                                <td colSpan="4" className="py-4 px-6 text-center text-gray-500">Chưa có sản phẩm nào.</td>
                            </tr>
                        ) : (
                            products.map((product) => (
                                <tr key={product.id} className="border-b border-gray-200 hover:bg-gray-100">
                                    <td className="py-3 px-6 text-left whitespace-nowrap">{product.name}</td>
                                    <td className="py-3 px-6 text-left">{formatCurrency(product.price)}</td>
                                    <td className="py-3 px-6 text-left">{product.stock}</td>
                                    <td className="py-3 px-6 text-center">
                                        <div className="flex item-center justify-center space-x-2">
                                            <button
                                                onClick={() => setEditingProduct(product)}
                                                className="bg-yellow-500 text-white p-2 rounded-full hover:bg-yellow-600 transition-colors duration-200"
                                                title="Chỉnh sửa"
                                            >
                                                <i className="fas fa-edit text-sm"></i>
                                            </button>
                                            <button
                                                onClick={() => handleDeleteProduct(product.id)}
                                                className="bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition-colors duration-200"
                                                title="Xóa"
                                            >
                                                <i className="fas fa-trash-alt text-sm"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>
        </div>
    );
};

// Component Đơn hàng (Orders)
const Orders = () => {
    const { db, userId, showAppMessage, showConfirmation } = useContext(AppContext);
    const [orders, setOrders] = useState([]);
    const [products, setProducts] = useState([]); // Để chọn sản phẩm trong đơn hàng
    const [customers, setCustomers] = useState([]); // Để chọn khách hàng trong đơn hàng
    const [newOrder, setNewOrder] = useState({ customerId: '', items: [], status: 'pending', totalAmount: 0, paidAmount: 0 });
    const [editingOrder, setEditingOrder] = useState(null);

    useEffect(() => {
        if (!db || !userId) return;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const ordersCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/orders`);
        const productsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/products`);
        const customersCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/customers`);

        const unsubscribeOrders = onSnapshot(ordersCollectionRef, (snapshot) => {
            const ordersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setOrders(ordersData);
        }, (error) => {
            console.error("Lỗi khi lấy dữ liệu đơn hàng:", error);
            showAppMessage("Không thể tải dữ liệu đơn hàng.", 5000);
        });

        const unsubscribeProducts = onSnapshot(productsCollectionRef, (snapshot) => {
            const productsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setProducts(productsData);
        }, (error) => {
            console.error("Lỗi khi lấy dữ liệu sản phẩm:", error);
        });

        const unsubscribeCustomers = onSnapshot(customersCollectionRef, (snapshot) => {
            const customersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setCustomers(customersData);
        }, (error) => {
            console.error("Lỗi khi lấy dữ liệu khách hàng:", error);
        });

        return () => {
            unsubscribeOrders();
            unsubscribeProducts();
            unsubscribeCustomers();
        };
    }, [db, userId, showAppMessage]);

    const calculateTotalAmount = (items) => {
        return items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    };

    const handleAddItemToOrder = (orderState, setOrderState, productId, quantity) => {
        const product = products.find(p => p.id === productId);
        if (!product || quantity <= 0) {
            showAppMessage("Vui lòng chọn sản phẩm và số lượng hợp lệ.", 3000);
            return;
        }

        const existingItemIndex = orderState.items.findIndex(item => item.productId === productId);
        let updatedItems;
        if (existingItemIndex > -1) {
            updatedItems = orderState.items.map((item, index) =>
                index === existingItemIndex ? { ...item, quantity: item.quantity + quantity } : item
            );
        } else {
            updatedItems = [...orderState.items, { productId: product.id, name: product.name, price: product.price, quantity: quantity }];
        }
        setOrderState({ ...orderState, items: updatedItems, totalAmount: calculateTotalAmount(updatedItems) });
    };

    const handleRemoveItemFromOrder = (orderState, setOrderState, productId) => {
        const updatedItems = orderState.items.filter(item => item.productId !== productId);
        setOrderState({ ...orderState, items: updatedItems, totalAmount: calculateTotalAmount(updatedItems) });
    };

    const handleAddOrder = async () => {
        if (!newOrder.customerId || newOrder.items.length === 0) {
            showAppMessage("Vui lòng chọn khách hàng và thêm sản phẩm vào đơn hàng.", 3000);
            return;
        }
        if (isNaN(newOrder.paidAmount) || parseFloat(newOrder.paidAmount) < 0) {
            showAppMessage("Số tiền đã thanh toán phải là số không âm.", 3000);
            return;
        }

        try {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            await addDoc(collection(db, `artifacts/${appId}/users/${userId}/orders`), {
                customerId: newOrder.customerId,
                customerName: customers.find(c => c.id === newOrder.customerId)?.name || 'Không rõ',
                items: newOrder.items,
                totalAmount: newOrder.totalAmount,
                paidAmount: parseFloat(newOrder.paidAmount),
                status: newOrder.status,
                createdAt: serverTimestamp()
            });
            setNewOrder({ customerId: '', items: [], status: 'pending', totalAmount: 0, paidAmount: 0 });
            showAppMessage("Đơn hàng đã được thêm thành công!");
        } catch (e) {
            console.error("Lỗi khi thêm đơn hàng: ", e);
            showAppMessage("Lỗi khi thêm đơn hàng.", 5000);
        }
    };

    const handleUpdateOrder = async () => {
        if (!editingOrder.customerId || editingOrder.items.length === 0) {
            showAppMessage("Vui lòng chọn khách hàng và thêm sản phẩm vào đơn hàng.", 3000);
            return;
        }
        if (isNaN(editingOrder.paidAmount) || parseFloat(editingOrder.paidAmount) < 0) {
            showAppMessage("Số tiền đã thanh toán phải là số không âm.", 3000);
            return;
        }

        try {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const orderRef = doc(db, `artifacts/${appId}/users/${userId}/orders`, editingOrder.id);
            await updateDoc(orderRef, {
                customerId: editingOrder.customerId,
                customerName: customers.find(c => c.id === editingOrder.customerId)?.name || 'Không rõ',
                items: editingOrder.items,
                totalAmount: editingOrder.totalAmount,
                paidAmount: parseFloat(editingOrder.paidAmount),
                status: editingOrder.status,
                updatedAt: serverTimestamp()
            });
            setEditingOrder(null);
            showAppMessage("Đơn hàng đã được cập nhật thành công!");
        } catch (e) {
            console.error("Lỗi khi cập nhật đơn hàng: ", e);
            showAppMessage("Lỗi khi cập nhật đơn hàng.", 5000);
        }
    };

    const handleDeleteOrder = async (id) => {
        showConfirmation("Bạn có chắc chắn muốn xóa đơn hàng này?", async () => {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/orders`, id));
                showAppMessage("Đơn hàng đã được xóa thành công!");
            } catch (e) {
                console.error("Lỗi khi xóa đơn hàng: ", e);
                showAppMessage("Lỗi khi xóa đơn hàng.", 5000);
            }
        });
    };

    const formatCurrency = (amount) => {
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
    };

    const getStatusClass = (status) => {
        switch (status) {
            case 'completed': return 'bg-green-100 text-green-800';
            case 'pending': return 'bg-yellow-100 text-yellow-800';
            case 'cancelled': return 'bg-red-100 text-red-800';
            case 'pending_payment': return 'bg-orange-100 text-orange-800';
            case 'partially_paid': return 'bg-blue-100 text-blue-800';
            default: return 'bg-gray-100 text-gray-800';
        }
    };

    return (
        <div className="bg-white p-6 rounded-lg shadow-md">
            <h3 className="text-xl font-semibold text-gray-700 mb-4">Quản lý Đơn hàng</h3>

            <div className="mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                <h4 className="text-lg font-medium text-gray-700 mb-3">{editingOrder ? 'Chỉnh sửa Đơn hàng' : 'Tạo Đơn hàng mới'}</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <select
                        className="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        value={editingOrder ? editingOrder.customerId : newOrder.customerId}
                        onChange={(e) => editingOrder ? setEditingOrder({ ...editingOrder, customerId: e.target.value }) : setNewOrder({ ...newOrder, customerId: e.target.value })}
                    >
                        <option value="">Chọn khách hàng</option>
                        {customers.map(customer => (
                            <option key={customer.id} value={customer.id}>{customer.name}</option>
                        ))}
                    </select>
                    <select
                        className="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        value={editingOrder ? editingOrder.status : newOrder.status}
                        onChange={(e) => editingOrder ? setEditingOrder({ ...editingOrder, status: e.target.value }) : setNewOrder({ ...newOrder, status: e.target.value })}
                    >
                        <option value="pending">Đang chờ</option>
                        <option value="completed">Hoàn thành</option>
                        <option value="cancelled">Đã hủy</option>
                        <option value="pending_payment">Chờ thanh toán</option>
                        <option value="partially_paid">Đã thanh toán một phần</option>
                    </select>
                </div>

                <div className="mb-4 p-3 border border-gray-300 rounded-md bg-white">
                    <h5 className="font-medium mb-2">Thêm sản phẩm vào đơn hàng</h5>
                    <div className="flex flex-col sm:flex-row gap-2">
                        <select
                            id="product-select"
                            className="flex-1 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            <option value="">Chọn sản phẩm</option>
                            {products.map(product => (
                                <option key={product.id} value={product.id}>{product.name} ({formatCurrency(product.price)})</option>
                            ))}
                        </select>
                        <input
                            type="number"
                            id="product-quantity"
                            placeholder="Số lượng"
                            className="w-24 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            min="1"
                            defaultValue="1"
                        />
                        <button
                            onClick={() => {
                                const productId = document.getElementById('product-select').value;
                                const quantity = parseInt(document.getElementById('product-quantity').value);
                                if (editingOrder) {
                                    handleAddItemToOrder(editingOrder, setEditingOrder, productId, quantity);
                                } else {
                                    handleAddItemToOrder(newOrder, setNewOrder, productId, quantity);
                                }
                            }}
                            className="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors duration-200"
                        >
                            Thêm
                        </button>
                    </div>
                    <div className="mt-4">
                        <h6 className="font-medium mb-2">Sản phẩm trong đơn hàng:</h6>
                        {(editingOrder ? editingOrder.items : newOrder.items).length === 0 ? (
                            <p className="text-gray-500 text-sm">Chưa có sản phẩm nào được thêm.</p>
                        ) : (
                            <ul className="list-disc pl-5 text-sm">
                                {(editingOrder ? editingOrder.items : newOrder.items).map((item, index) => (
                                    <li key={index} className="flex justify-between items-center py-1">
                                        <span>{item.name} x {item.quantity} ({formatCurrency(item.price * item.quantity)})</span>
                                        <button
                                            onClick={() => {
                                                if (editingOrder) {
                                                    handleRemoveItemFromOrder(editingOrder, setEditingOrder, item.productId);
                                                } else {
                                                    handleRemoveItemFromOrder(newOrder, setNewOrder, item.productId);
                                                }
                                            }}
                                            className="text-red-500 hover:text-red-700 ml-2"
                                            title="Xóa sản phẩm khỏi đơn hàng"
                                        >
                                            <i className="fas fa-times-circle"></i>
                                        </button>
                                    </li>
                                ))}
                            </ul>
                        )}
                        <p className="font-semibold text-right mt-2">Tổng cộng: {formatCurrency(editingOrder ? editingOrder.totalAmount : newOrder.totalAmount)}</p>
                    </div>
                </div>

                <div className="mb-4">
                    <label htmlFor="paid-amount" className="block text-sm font-medium text-gray-700 mb-1">Số tiền đã thanh toán:</label>
                    <input
                        type="number"
                        id="paid-amount"
                        placeholder="Số tiền đã thanh toán"
                        className="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        value={editingOrder ? editingOrder.paidAmount : newOrder.paidAmount}
                        onChange={(e) => editingOrder ? setEditingOrder({ ...editingOrder, paidAmount: e.target.value }) : setNewOrder({ ...newOrder, paidAmount: e.target.value })}
                    />
                </div>

                {editingOrder ? (
                    <div className="flex space-x-2">
                        <button
                            onClick={handleUpdateOrder}
                            className="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition-colors duration-200"
                        >
                            Cập nhật Đơn hàng
                        </button>
                        <button
                            onClick={() => setEditingOrder(null)}
                            className="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition-colors duration-200"
                        >
                            Hủy
                        </button>
                    </div>
                ) : (
                    <button
                        onClick={handleAddOrder}
                        className="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors duration-200"
                    >
                        Tạo Đơn hàng
                    </button>
                )}
            </div>

            <div className="overflow-x-auto">
                <table className="min-w-full bg-white rounded-lg shadow-sm">
                    <thead>
                        <tr className="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                            <th className="py-3 px-6 text-left">Khách hàng</th>
                            <th className="py-3 px-6 text-left">Sản phẩm</th>
                            <th className="py-3 px-6 text-left">Tổng tiền</th>
                            <th className="py-3 px-6 text-left">Đã thanh toán</th>
                            <th className="py-3 px-6 text-left">Trạng thái</th>
                            <th className="py-3 px-6 text-center">Hành động</th>
                        </tr>
                    </thead>
                    <tbody className="text-gray-600 text-sm font-light">
                        {orders.length === 0 ? (
                            <tr>
                                <td colSpan="6" className="py-4 px-6 text-center text-gray-500">Chưa có đơn hàng nào.</td>
                            </tr>
                        ) : (
                            orders.map((order) => (
                                <tr key={order.id} className="border-b border-gray-200 hover:bg-gray-100">
                                    <td className="py-3 px-6 text-left whitespace-nowrap">{order.customerName}</td>
                                    <td className="py-3 px-6 text-left">
                                        <ul className="list-disc pl-4">
                                            {order.items && order.items.map((item, idx) => (
                                                <li key={idx}>{item.name} (x{item.quantity})</li>
                                            ))}
                                        </ul>
                                    </td>
                                    <td className="py-3 px-6 text-left">{formatCurrency(order.totalAmount)}</td>
                                    <td className="py-3 px-6 text-left">{formatCurrency(order.paidAmount)}</td>
                                    <td className="py-3 px-6 text-left">
                                        <span className={`px-2 py-1 rounded-full text-xs font-semibold ${getStatusClass(order.status)}`}>
                                            {order.status === 'pending' ? 'Đang chờ' : order.status === 'completed' ? 'Hoàn thành' : order.status === 'cancelled' ? 'Đã hủy' : order.status === 'pending_payment' ? 'Chờ thanh toán' : 'Đã TT một phần'}
                                        </span>
                                    </td>
                                    <td className="py-3 px-6 text-center">
                                        <div className="flex item-center justify-center space-x-2">
                                            <button
                                                onClick={() => setEditingOrder(order)}
                                                className="bg-yellow-500 text-white p-2 rounded-full hover:bg-yellow-600 transition-colors duration-200"
                                                title="Chỉnh sửa"
                                            >
                                                <i className="fas fa-edit text-sm"></i>
                                            </button>
                                            <button
                                                onClick={() => handleDeleteOrder(order.id)}
                                                className="bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition-colors duration-200"
                                                title="Xóa"
                                            >
                                                <i className="fas fa-trash-alt text-sm"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>
        </div>
    );
};


// Component Khách hàng (Customers)
const Customers = () => {
    const { db, userId, showAppMessage, showConfirmation } = useContext(AppContext);
    const [customers, setCustomers] = useState([]);
    const [newCustomer, setNewCustomer] = useState({ name: '', email: '', phone: '', address: '' });
    const [editingCustomer, setEditingCustomer] = useState(null);

    useEffect(() => {
        if (!db || !userId) return;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const customersCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/customers`);

        const unsubscribe = onSnapshot(customersCollectionRef, (snapshot) => {
            const customersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setCustomers(customersData);
        }, (error) => {
            console.error("Lỗi khi lấy dữ liệu khách hàng:", error);
            showAppMessage("Không thể tải dữ liệu khách hàng.", 5000);
        });

        return () => unsubscribe();
    }, [db, userId, showAppMessage]);

    const handleAddCustomer = async () => {
        if (!newCustomer.name || !newCustomer.email || !newCustomer.phone) {
            showAppMessage("Vui lòng điền đầy đủ thông tin khách hàng (Tên, Email, Điện thoại).", 3000);
            return;
        }
        try {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            await addDoc(collection(db, `artifacts/${appId}/users/${userId}/customers`), {
                name: newCustomer.name,
                email: newCustomer.email,
                phone: newCustomer.phone,
                address: newCustomer.address,
                createdAt: serverTimestamp()
            });
            setNewCustomer({ name: '', email: '', phone: '', address: '' });
            showAppMessage("Khách hàng đã được thêm thành công!");
        } catch (e) {
            console.error("Lỗi khi thêm khách hàng: ", e);
            showAppMessage("Lỗi khi thêm khách hàng.", 5000);
        }
    };

    const handleUpdateCustomer = async () => {
        if (!editingCustomer.name || !editingCustomer.email || !editingCustomer.phone) {
            showAppMessage("Vui lòng điền đầy đủ thông tin khách hàng (Tên, Email, Điện thoại).", 3000);
            return;
        }
        try {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const customerRef = doc(db, `artifacts/${appId}/users/${userId}/customers`, editingCustomer.id);
            await updateDoc(customerRef, {
                name: editingCustomer.name,
                email: editingCustomer.email,
                phone: editingCustomer.phone,
                address: editingCustomer.address,
                updatedAt: serverTimestamp()
            });
            setEditingCustomer(null);
            showAppMessage("Khách hàng đã được cập nhật thành công!");
        } catch (e) {
            console.error("Lỗi khi cập nhật khách hàng: ", e);
            showAppMessage("Lỗi khi cập nhật khách hàng.", 5000);
        }
    };

    const handleDeleteCustomer = async (id) => {
        showConfirmation("Bạn có chắc chắn muốn xóa khách hàng này?", async () => {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/customers`, id));
                showAppMessage("Khách hàng đã được xóa thành công!");
            } catch (e) {
                console.error("Lỗi khi xóa khách hàng: ", e);
                showAppMessage("Lỗi khi xóa khách hàng.", 5000);
            }
        });
    };

    return (
        <div className="bg-white p-6 rounded-lg shadow-md">
            <h3 className="text-xl font-semibold text-gray-700 mb-4">Quản lý Khách hàng</h3>

            <div className="mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                <h4 className="text-lg font-medium text-gray-700 mb-3">{editingCustomer ? 'Chỉnh sửa Khách hàng' : 'Thêm Khách hàng mới'}</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input
                        type="text"
                        placeholder="Tên khách hàng"
                        className="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        value={editingCustomer ? editingCustomer.name : newCustomer.name}
                        onChange={(e) => editingCustomer ? setEditingCustomer({ ...editingCustomer, name: e.target.value }) : setNewCustomer({ ...newCustomer, name: e.target.value })}
                    />
                    <input
                        type="email"
                        placeholder="Email"
                        className="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        value={editingCustomer ? editingCustomer.email : newCustomer.email}
                        onChange={(e) => editingCustomer ? setEditingCustomer({ ...editingCustomer, email: e.target.value }) : setNewCustomer({ ...newCustomer, email: e.target.value })}
                    />
                    <input
                        type="tel"
                        placeholder="Số điện thoại"
                        className="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        value={editingCustomer ? editingCustomer.phone : newCustomer.phone}
                        onChange={(e) => editingCustomer ? setEditingCustomer({ ...editingCustomer, phone: e.target.value }) : setNewCustomer({ ...newCustomer, phone: e.target.value })}
                    />
                    <input
                        type="text"
                        placeholder="Địa chỉ"
                        className="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        value={editingCustomer ? editingCustomer.address : newCustomer.address}
                        onChange={(e) => editingCustomer ? setEditingCustomer({ ...editingCustomer, address: e.target.value }) : setNewCustomer({ ...newCustomer, address: e.target.value })}
                    />
                </div>
                {editingCustomer ? (
                    <div className="flex space-x-2">
                        <button
                            onClick={handleUpdateCustomer}
                            className="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition-colors duration-200"
                        >
                            Cập nhật Khách hàng
                        </button>
                        <button
                            onClick={() => setEditingCustomer(null)}
                            className="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition-colors duration-200"
                        >
                            Hủy
                        </button>
                    </div>
                ) : (
                    <button
                        onClick={handleAddCustomer}
                        className="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors duration-200"
                    >
                        Thêm Khách hàng
                    </button>
                )}
            </div>

            <div className="overflow-x-auto">
                <table className="min-w-full bg-white rounded-lg shadow-sm">
                    <thead>
                        <tr className="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                            <th className="py-3 px-6 text-left">Tên</th>
                            <th className="py-3 px-6 text-left">Email</th>
                            <th className="py-3 px-6 text-left">Điện thoại</th>
                            <th className="py-3 px-6 text-left">Địa chỉ</th>
                            <th className="py-3 px-6 text-center">Hành động</th>
                        </tr>
                    </thead>
                    <tbody className="text-gray-600 text-sm font-light">
                        {customers.length === 0 ? (
                            <tr>
                                <td colSpan="5" className="py-4 px-6 text-center text-gray-500">Chưa có khách hàng nào.</td>
                            </tr>
                        ) : (
                            customers.map((customer) => (
                                <tr key={customer.id} className="border-b border-gray-200 hover:bg-gray-100">
                                    <td className="py-3 px-6 text-left whitespace-nowrap">{customer.name}</td>
                                    <td className="py-3 px-6 text-left">{customer.email}</td>
                                    <td className="py-3 px-6 text-left">{customer.phone}</td>
                                    <td className="py-3 px-6 text-left">{customer.address || 'N/A'}</td>
                                    <td className="py-3 px-6 text-center">
                                        <div className="flex item-center justify-center space-x-2">
                                            <button
                                                onClick={() => setEditingCustomer(customer)}
                                                className="bg-yellow-500 text-white p-2 rounded-full hover:bg-yellow-600 transition-colors duration-200"
                                                title="Chỉnh sửa"
                                            >
                                                <i className="fas fa-edit text-sm"></i>
                                            </button>
                                            <button
                                                onClick={() => handleDeleteCustomer(customer.id)}
                                                className="bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition-colors duration-200"
                                                title="Xóa"
                                            >
                                                <i className="fas fa-trash-alt text-sm"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>
        </div>
    );
};

// Component Tài chính (Finance)
const Finance = () => {
    const { db, userId, showAppMessage, showConfirmation } = useContext(AppContext);
    const [transactions, setTransactions] = useState([]);
    const [newTransaction, setNewTransaction] = useState({ type: 'expense', amount: '', description: '' });
    const [editingTransaction, setEditingTransaction] = useState(null);

    useEffect(() => {
        if (!db || !userId) return;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const financeCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/finance`);

        const unsubscribe = onSnapshot(financeCollectionRef, (snapshot) => {
            const transactionsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            // Sắp xếp theo thời gian tạo mới nhất
            transactionsData.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
            setTransactions(transactionsData);
        }, (error) => {
            console.error("Lỗi khi lấy dữ liệu tài chính:", error);
            showAppMessage("Không thể tải dữ liệu tài chính.", 5000);
        });

        return () => unsubscribe();
    }, [db, userId, showAppMessage]);

    const handleAddTransaction = async () => {
        if (!newTransaction.amount || !newTransaction.description) {
            showAppMessage("Vui lòng điền đầy đủ số tiền và mô tả.", 3000);
            return;
        }
        if (isNaN(newTransaction.amount) || parseFloat(newTransaction.amount) <= 0) {
            showAppMessage("Số tiền phải là số dương.", 3000);
            return;
        }

        try {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            await addDoc(collection(db, `artifacts/${appId}/users/${userId}/finance`), {
                type: newTransaction.type,
                amount: parseFloat(newTransaction.amount),
                description: newTransaction.description,
                createdAt: serverTimestamp()
            });
            setNewTransaction({ type: 'expense', amount: '', description: '' });
            showAppMessage("Giao dịch đã được thêm thành công!");
        } catch (e) {
            console.error("Lỗi khi thêm giao dịch: ", e);
            showAppMessage("Lỗi khi thêm giao dịch.", 5000);
        }
    };

    const handleUpdateTransaction = async () => {
        if (!editingTransaction.amount || !editingTransaction.description) {
            showAppMessage("Vui lòng điền đầy đủ số tiền và mô tả.", 3000);
            return;
        }
        if (isNaN(editingTransaction.amount) || parseFloat(editingTransaction.amount) <= 0) {
            showAppMessage("Số tiền phải là số dương.", 3000);
            return;
        }

        try {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const transactionRef = doc(db, `artifacts/${appId}/users/${userId}/finance`, editingTransaction.id);
            await updateDoc(transactionRef, {
                type: editingTransaction.type,
                amount: parseFloat(editingTransaction.amount),
                description: editingTransaction.description,
                updatedAt: serverTimestamp()
            });
            setEditingTransaction(null);
            showAppMessage("Giao dịch đã được cập nhật thành công!");
        } catch (e) {
                console.error("Lỗi khi cập nhật giao dịch: ", e);
                showAppMessage("Lỗi khi cập nhật giao dịch.", 5000);
        }
    };

    const handleDeleteTransaction = async (id) => {
        showConfirmation("Bạn có chắc chắn muốn xóa giao dịch này?", async () => {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/finance`, id));
                showAppMessage("Giao dịch đã được xóa thành công!");
            } catch (e) {
                console.error("Lỗi khi xóa giao dịch: ", e);
                showAppMessage("Lỗi khi xóa giao dịch.", 5000);
            }
        });
    };

    const formatCurrency = (amount) => {
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
    };

    return (
        <div className="bg-white p-6 rounded-lg shadow-md">
            <h3 className="text-xl font-semibold text-gray-700 mb-4">Quản lý Thu chi</h3>

            <div className="mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                <h4 className="text-lg font-medium text-gray-700 mb-3">{editingTransaction ? 'Chỉnh sửa Giao dịch' : 'Thêm Giao dịch mới'}</h4>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <select
                        className="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        value={editingTransaction ? editingTransaction.type : newTransaction.type}
                        onChange={(e) => editingTransaction ? setEditingTransaction({ ...editingTransaction, type: e.target.value }) : setNewTransaction({ ...newTransaction, type: e.target.value })}
                    >
                        <option value="expense">Chi phí</option>
                        <option value="income">Thu nhập</option>
                    </select>
                    <input
                        type="number"
                        placeholder="Số tiền"
                        className="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        value={editingTransaction ? editingTransaction.amount : newTransaction.amount}
                        onChange={(e) => editingTransaction ? setEditingTransaction({ ...editingTransaction, amount: e.target.value }) : setNewTransaction({ ...newTransaction, amount: e.target.value })}
                    />
                    <input
                        type="text"
                        placeholder="Mô tả"
                        className="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        value={editingTransaction ? editingTransaction.description : newTransaction.description}
                        onChange={(e) => editingTransaction ? setEditingTransaction({ ...editingTransaction, description: e.target.value }) : setNewTransaction({ ...newTransaction, description: e.target.value })}
                    />
                </div>
                {editingTransaction ? (
                    <div className="flex space-x-2">
                        <button
                            onClick={handleUpdateTransaction}
                            className="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition-colors duration-200"
                        >
                            Cập nhật Giao dịch
                        </button>
                        <button
                            onClick={() => setEditingTransaction(null)}
                            className="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition-colors duration-200"
                        >
                            Hủy
                        </button>
                    </div>
                ) : (
                    <button
                        onClick={handleAddTransaction}
                        className="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors duration-200"
                    >
                        Thêm Giao dịch
                    </button>
                )}
            </div>

            <div className="overflow-x-auto">
                <table className="min-w-full bg-white rounded-lg shadow-sm">
                    <thead>
                        <tr className="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                            <th className="py-3 px-6 text-left">Loại</th>
                            <th className="py-3 px-6 text-left">Số tiền</th>
                            <th className="py-3 px-6 text-left">Mô tả</th>
                            <th className="py-3 px-6 text-left">Ngày</th>
                            <th className="py-3 px-6 text-center">Hành động</th>
                        </tr>
                    </thead>
                    <tbody className="text-gray-600 text-sm font-light">
                        {transactions.length === 0 ? (
                            <tr>
                                <td colSpan="5" className="py-4 px-6 text-center text-gray-500">Chưa có giao dịch nào.</td>
                            </tr>
                        ) : (
                            transactions.map((transaction) => (
                                <tr key={transaction.id} className="border-b border-gray-200 hover:bg-gray-100">
                                    <td className="py-3 px-6 text-left">
                                        <span className={`px-2 py-1 rounded-full text-xs font-semibold ${transaction.type === 'income' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                            {transaction.type === 'income' ? 'Thu nhập' : 'Chi phí'}
                                        </span>
                                    </td>
                                    <td className="py-3 px-6 text-left">{formatCurrency(transaction.amount)}</td>
                                    <td className="py-3 px-6 text-left">{transaction.description}</td>
                                    <td className="py-3 px-6 text-left">{transaction.createdAt ? new Date(transaction.createdAt.toDate()).toLocaleDateString('vi-VN') : 'N/A'}</td>
                                    <td className="py-3 px-6 text-center">
                                        <div className="flex item-center justify-center space-x-2">
                                            <button
                                                onClick={() => setEditingTransaction(transaction)}
                                                className="bg-yellow-500 text-white p-2 rounded-full hover:bg-yellow-600 transition-colors duration-200"
                                                title="Chỉnh sửa"
                                            >
                                                <i className="fas fa-edit text-sm"></i>
                                            </button>
                                            <button
                                                onClick={() => handleDeleteTransaction(transaction.id)}
                                                className="bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition-colors duration-200"
                                                title="Xóa"
                                            >
                                                <i className="fas fa-trash-alt text-sm"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>
        </div>
    );
};

// Component Báo cáo (Reports)
const Reports = () => {
    const { db, userId, showAppMessage } = useContext(AppContext);
    const [reportData, setReportData] = useState({ totalIncome: 0, totalExpense: 0, netProfit: 0 });
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        if (!db || !userId) return;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const financeCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/finance`);

        const unsubscribe = onSnapshot(financeCollectionRef, (snapshot) => {
            let totalIncome = 0;
            let totalExpense = 0;
            snapshot.forEach((doc) => {
                const data = doc.data();
                if (data.type === 'income') {
                    totalIncome += data.amount;
                } else if (data.type === 'expense') {
                    totalExpense += data.amount;
                }
            });
            setReportData({
                totalIncome: totalIncome,
                totalExpense: totalExpense,
                netProfit: totalIncome - totalExpense
            });
            setLoading(false);
        }, (error) => {
            console.error("Lỗi khi lấy dữ liệu báo cáo:", error);
            showAppMessage("Không thể tải dữ liệu báo cáo.", 5000);
            setLoading(false);
        });

        return () => unsubscribe();
    }, [db, userId, showAppMessage]);

    const formatCurrency = (amount) => {
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
    };

    if (loading) {
        return (
            <div className="bg-white p-6 rounded-lg shadow-md text-center text-gray-600">
                Đang tải báo cáo...
            </div>
        );
    }

    return (
        <div className="bg-white p-6 rounded-lg shadow-md">
            <h3 className="text-xl font-semibold text-gray-700 mb-4">Báo cáo Tài chính</h3>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div className="bg-green-100 p-4 rounded-lg shadow-sm">
                    <p className="text-green-700 text-lg font-medium">Tổng thu nhập:</p>
                    <p className="text-green-900 text-3xl font-bold">{formatCurrency(reportData.totalIncome)}</p>
                </div>
                <div className="bg-red-100 p-4 rounded-lg shadow-sm">
                    <p className="text-red-700 text-lg font-medium">Tổng chi phí:</p>
                    <p className="text-red-900 text-3xl font-bold">{formatCurrency(reportData.totalExpense)}</p>
                </div>
                <div className={`p-4 rounded-lg shadow-sm ${reportData.netProfit >= 0 ? 'bg-blue-100' : 'bg-orange-100'}`}>
                    <p className={`${reportData.netProfit >= 0 ? 'text-blue-700' : 'text-orange-700'} text-lg font-medium`}>Lợi nhuận ròng:</p>
                    <p className={`${reportData.netProfit >= 0 ? 'text-blue-900' : 'text-orange-900'} text-3xl font-bold`}>{formatCurrency(reportData.netProfit)}</p>
                </div>
            </div>

            <div className="mt-8">
                <h4 className="text-lg font-semibold text-gray-700 mb-3">Phân tích chi tiết</h4>
                <p className="text-gray-600">
                    Phần này sẽ hiển thị các biểu đồ và bảng phân tích chi tiết hơn về doanh thu, chi phí, lợi nhuận theo thời gian, theo danh mục sản phẩm, hoặc theo khách hàng.
                    Bạn có thể tùy chỉnh để hiển thị các báo cáo cụ thể mà bạn cần.
                </p>
                <ul className="list-disc list-inside mt-4 text-gray-700">
                    <li>Báo cáo doanh thu theo tháng/quý/năm.</li>
                    <li>Báo cáo chi phí theo danh mục.</li>
                    <li>Báo cáo lợi nhuận theo sản phẩm.</li>
                    <li>Báo cáo công nợ phải thu/phải trả.</li>
                </ul>
            </div>
        </div>
    );
};

// Component AI Chat
const AIChat = () => {
    const { db, userId, showAppMessage } = useContext(AppContext);
    const [chatHistory, setChatHistory] = useState([]);
    const [input, setInput] = useState('');
    const [isThinking, setIsThinking] = useState(false);
    const chatContainerRef = useRef(null);

    // Cuộn xuống cuối lịch sử trò chuyện
    useEffect(() => {
        if (chatContainerRef.current) {
            chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;
        }
    }, [chatHistory]);

    const callGeminiAPI = async (prompt, schema = null) => {
        setIsThinking(true);
        let history = [...chatHistory, { role: "user", parts: [{ text: prompt }] }];
        setChatHistory(history);

        const payload = {
            contents: [{ role: "user", parts: [{ text: prompt }] }],
            generationConfig: schema ? { responseMimeType: "application/json", responseSchema: schema } : {}
        };

        const apiKey = ""; // Leave as-is, Canvas will provide at runtime
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                const text = result.candidates[0].content.parts[0].text;
                setIsThinking(false);
                return text;
            } else {
                console.error("Unexpected API response structure:", result);
                showAppMessage("Lỗi: Không nhận được phản hồi hợp lệ từ AI.", 5000);
                setIsThinking(false);
                return null;
            }
        } catch (error) {
            console.error("Lỗi khi gọi API Gemini:", error);
            showAppMessage("Lỗi khi kết nối với AI. Vui lòng thử lại.", 5000);
            setIsThinking(false);
            return null;
        }
    };

    const handleSendMessage = async () => {
        if (!input.trim()) return;

        const userMessage = input.trim();
        setInput('');

        // Kiểm tra các lệnh cụ thể
        if (userMessage.toLowerCase().includes("lời khuyên tài chính")) {
            await provideFinancialAdvice();
            return;
        }

        // Thử phân tích cú pháp dưới dạng mục nhập dữ liệu
        const dataEntrySchema = {
            type: "OBJECT",
            properties: {
                action: { type: "STRING", enum: ["add_finance_transaction", "add_product", "add_customer", "add_order", "none"] },
                data: {
                    type: "OBJECT",
                    properties: {
                        type: { type: "STRING", enum: ["income", "expense"] }, // For finance
                        amount: { type: "NUMBER" },
                        description: { type: "STRING" },
                        name: { type: "STRING" }, // For product/customer
                        price: { type: "NUMBER" }, // For product
                        stock: { type: "NUMBER" }, // For product
                        email: { type: "STRING" }, // For customer
                        phone: { type: "STRING" }, // For customer
                        address: { type: "STRING" }, // For customer
                        customerId: { type: "STRING" }, // For order
                        items: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    productId: { type: "STRING" },
                                    name: { type: "STRING" },
                                    price: { type: "NUMBER" },
                                    quantity: { type: "NUMBER" },
                                }
                            }
                        },
                        status: { type: "STRING" }, // For order
                        paidAmount: { type: "NUMBER" }, // For order
                    }
                }
            },
            propertyOrdering: ["action", "data"]
        };

        const dataEntryPrompt = `Phân tích yêu cầu sau của người dùng và trả về dưới dạng JSON.
        Nếu yêu cầu là để thêm một giao dịch tài chính (thu nhập hoặc chi phí), hãy sử dụng action "add_finance_transaction" và cung cấp type (income/expense), amount (số), và description (chuỗi).
        Nếu yêu cầu là để thêm một sản phẩm, hãy sử dụng action "add_product" và cung cấp name (chuỗi), price (số), và stock (số).
        Nếu yêu cầu là để thêm một khách hàng, hãy sử dụng action "add_customer" và cung cấp name (chuỗi), email (chuỗi), phone (chuỗi), và address (chuỗi).
        Nếu yêu cầu là để thêm một đơn hàng, hãy sử dụng action "add_order" và cung cấp customerId (chuỗi), items (mảng các đối tượng {productId, name, price, quantity}), status (chuỗi, ví dụ: 'pending', 'completed'), paidAmount (số).
        Nếu không phải là yêu cầu nhập liệu, hãy sử dụng action "none" và không cung cấp data.

        Ví dụ:
        - "Thêm chi phí 500000 cho tiền điện nước" -> {"action": "add_finance_transaction", "data": {"type": "expense", "amount": 500000, "description": "Tiền điện nước"}}
        - "Thêm thu nhập 12000000 từ lương tháng 6" -> {"action": "add_finance_transaction", "data": {"type": "income", "amount": 12000000, "description": "Lương tháng 6"}}
        - "Thêm sản phẩm mới: Bút bi, giá 5000, tồn kho 200" -> {"action": "add_product", "data": {"name": "Bút bi", "price": 5000, "stock": 200}}
        - "Thêm khách hàng: Nguyễn Văn A, email a@example.com, sdt 0912345678, địa chỉ 123 Đường ABC" -> {"action": "add_customer", "data": {"name": "Nguyễn Văn A", "email": "a@example.com", "phone": "0912345678", "address": "123 Đường ABC"}}
        - "Tạo đơn hàng cho khách hàng XYZ, sản phẩm A số lượng 2, sản phẩm B số lượng 1, tổng 150000, đã thanh toán 100000, trạng thái pending" -> {"action": "add_order", "data": {"customerId": "XYZ_ID", "items": [{"productId": "A_ID", "name": "Sản phẩm A", "price": 50000, "quantity": 2}, {"productId": "B_ID", "name": "Sản phẩm B", "price": 50000, "quantity": 1}], "totalAmount": 150000, "paidAmount": 100000, "status": "pending"}}
        - "Chào bạn" -> {"action": "none"}

        Yêu cầu của người dùng: "${userMessage}"`;

        const aiResponse = await callGeminiAPI(dataEntryPrompt, dataEntrySchema);

        if (aiResponse) {
            try {
                const parsedResponse = JSON.parse(aiResponse);
                let botMessage = '';

                if (parsedResponse.action === "add_finance_transaction") {
                    const { type, amount, description } = parsedResponse.data;
                    if (type && amount && description) {
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/finance`), {
                            type: type,
                            amount: parseFloat(amount),
                            description: description,
                            createdAt: serverTimestamp()
                        });
                        botMessage = `Đã thêm giao dịch ${type === 'income' ? 'thu nhập' : 'chi phí'}: ${description} với số tiền ${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount)}.`;
                    } else {
                        botMessage = "Tôi không thể hiểu rõ thông tin giao dịch. Vui lòng cung cấp đầy đủ loại, số tiền và mô tả.";
                    }
                } else if (parsedResponse.action === "add_product") {
                    const { name, price, stock } = parsedResponse.data;
                    if (name && price && stock) {
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/products`), {
                            name: name,
                            price: parseFloat(price),
                            stock: parseInt(stock),
                            createdAt: serverTimestamp()
                        });
                        botMessage = `Đã thêm sản phẩm: ${name} với giá ${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(price)} và tồn kho ${stock}.`;
                    } else {
                        botMessage = "Tôi không thể hiểu rõ thông tin sản phẩm. Vui lòng cung cấp đầy đủ tên, giá và số lượng tồn kho.";
                    }
                } else if (parsedResponse.action === "add_customer") {
                    const { name, email, phone, address } = parsedResponse.data;
                    if (name && email && phone) {
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/customers`), {
                            name: name,
                            email: email,
                            phone: phone,
                            address: address || '',
                            createdAt: serverTimestamp()
                        });
                        botMessage = `Đã thêm khách hàng: ${name} (${email}, ${phone}).`;
                    } else {
                        botMessage = "Tôi không thể hiểu rõ thông tin khách hàng. Vui lòng cung cấp đầy đủ tên, email và số điện thoại.";
                    }
                } else if (parsedResponse.action === "add_order") {
                    const { customerId, items, status, totalAmount, paidAmount } = parsedResponse.data;
                    if (customerId && items && items.length > 0 && status && totalAmount && paidAmount !== undefined) {
                        // For simplicity, we assume customerId and productIds are already known or can be looked up.
                        // In a real app, you'd need to query Firestore to get actual customer/product IDs and names.
                        // For this example, we'll use the provided customerId and items as-is.
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                        // Fetch customer name based on customerId (assuming customerId is the name for simplicity in parsing)
                        let actualCustomerId = customerId;
                        let actualCustomerName = customerId; // Fallback to ID if not found
                        const customersRef = collection(db, `artifacts/${appId}/users/${userId}/customers`);
                        const q = query(customersRef, where("name", "==", customerId));
                        const customerSnapshot = await getDocs(q);
                        if (!customerSnapshot.empty) {
                            actualCustomerId = customerSnapshot.docs[0].id;
                            actualCustomerName = customerSnapshot.docs[0].data().name;
                        } else {
                            // If customer not found by name, try to add them or inform user
                            botMessage = `Không tìm thấy khách hàng "${customerId}". Vui lòng tạo khách hàng trước hoặc cung cấp ID chính xác.`;
                            setChatHistory(prev => [...prev, { role: "model", parts: [{ text: botMessage }] }]);
                            return;
                        }

                        // Prepare items with actual product data if possible (simplified for this example)
                        const processedItems = await Promise.all(items.map(async item => {
                            const productRef = collection(db, `artifacts/${appId}/users/${userId}/products`);
                            const productQuery = query(productRef, where("name", "==", item.name));
                            const productSnapshot = await getDocs(productQuery);
                            if (!productSnapshot.empty) {
                                const productData = productSnapshot.docs[0].data();
                                return {
                                    productId: productSnapshot.docs[0].id,
                                    name: productData.name,
                                    price: productData.price,
                                    quantity: item.quantity
                                };
                            } else {
                                showAppMessage(`Cảnh báo: Sản phẩm "${item.name}" không tìm thấy.`, 3000);
                                return { ...item, productId: 'unknown' }; // Use provided data if not found
                            }
                        }));

                        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/orders`), {
                            customerId: actualCustomerId,
                            customerName: actualCustomerName,
                            items: processedItems,
                            totalAmount: parseFloat(totalAmount),
                            paidAmount: parseFloat(paidAmount),
                            status: status,
                            createdAt: serverTimestamp()
                        });
                        botMessage = `Đã tạo đơn hàng cho khách hàng ${actualCustomerName}. Tổng tiền: ${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(totalAmount)}.`;
                    } else {
                        botMessage = "Tôi không thể hiểu rõ thông tin đơn hàng. Vui lòng cung cấp đầy đủ khách hàng, sản phẩm, tổng tiền, số tiền đã thanh toán và trạng thái.";
                    }
                }
                else {
                    // If action is 'none' or unrecognized, just respond conversationally
                    const conversationalResponse = await callGeminiAPI(`Bạn là một thư ký AI cho một ứng dụng quản lý bán hàng và thu chi. Hãy trả lời câu hỏi sau của người dùng một cách thân thiện và hữu ích, không cần định dạng JSON: "${userMessage}"`);
                    botMessage = conversationalResponse || "Xin lỗi, tôi không hiểu yêu cầu của bạn. Bạn có thể thử lại hoặc hỏi về 'lời khuyên tài chính' không?";
                }
                setChatHistory(prev => [...prev, { role: "model", parts: [{ text: botMessage }] }]);

            } catch (e) {
                console.error("Lỗi khi phân tích phản hồi AI hoặc thêm dữ liệu:", e);
                const conversationalResponse = await callGeminiAPI(`Bạn là một thư ký AI cho một ứng dụng quản lý bán hàng và thu chi. Hãy trả lời câu hỏi sau của người dùng một cách thân thiện và hữu ích, không cần định dạng JSON: "${userMessage}"`);
                setChatHistory(prev => [...prev, { role: "model", parts: [{ text: conversationalResponse || "Xin lỗi, tôi gặp sự cố khi xử lý yêu cầu của bạn. Vui lòng thử lại." }] }]);
            }
        }
    };

    const provideFinancialAdvice = async () => {
        setIsThinking(true);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const financeCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/finance`);
        const productsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/products`);
        const ordersCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/orders`);

        let totalIncome = 0;
        let totalExpense = 0;
        let totalInventoryValue = 0;
        let totalRevenue = 0;
        let accountsReceivable = 0;

        try {
            const financeSnapshot = await getDocs(financeCollectionRef);
            financeSnapshot.forEach(doc => {
                const data = doc.data();
                if (data.type === 'income') {
                    totalIncome += data.amount;
                } else if (data.type === 'expense') {
                    totalExpense += data.amount;
                }
            });

            const productsSnapshot = await getDocs(productsCollectionRef);
            productsSnapshot.forEach(doc => {
                const data = doc.data();
                totalInventoryValue += (data.price || 0) * (data.stock || 0);
            });

            const ordersSnapshot = await getDocs(ordersCollectionRef);
            ordersSnapshot.forEach(doc => {
                const data = doc.data();
                totalRevenue += data.totalAmount || 0;
                if (data.status === 'pending_payment' || data.status === 'partially_paid') {
                    accountsReceivable += (data.totalAmount || 0) - (data.paidAmount || 0);
                }
            });

            const advicePrompt = `Dựa trên dữ liệu tài chính sau, hãy đưa ra lời khuyên hữu ích và thực tế cho người dùng:
            - Tổng thu nhập: ${totalIncome} VND
            - Tổng chi phí: ${totalExpense} VND
            - Lợi nhuận ròng: ${totalIncome - totalExpense} VND
            - Tổng giá trị kho: ${totalInventoryValue} VND
            - Tổng doanh thu: ${totalRevenue} VND
            - Công nợ phải thu: ${accountsReceivable} VND

            Hãy tập trung vào việc cải thiện hiệu quả kinh doanh, quản lý tài chính, và tối ưu hóa lợi nhuận.`;

            const aiAdvice = await callGeminiAPI(advicePrompt);
            setChatHistory(prev => [...prev, { role: "model", parts: [{ text: aiAdvice || "Xin lỗi, tôi không thể đưa ra lời khuyên tài chính lúc này." }] }]);

        } catch (error) {
            console.error("Lỗi khi lấy dữ liệu hoặc tạo lời khuyên AI:", error);
            showAppMessage("Không thể lấy dữ liệu để đưa ra lời khuyên tài chính.", 5000);
            setChatHistory(prev => [...prev, { role: "model", parts: [{ text: "Xin lỗi, tôi gặp sự cố khi lấy dữ liệu để đưa ra lời khuyên tài chính." }] }]);
        } finally {
            setIsThinking(false);
        }
    };

    return (
        <div className="bg-white p-6 rounded-lg shadow-md flex flex-col h-full">
            <h3 className="text-xl font-semibold text-gray-700 mb-4">Trò chuyện với AI</h3>
            <div ref={chatContainerRef} className="flex-1 overflow-y-auto border border-gray-200 rounded-lg p-4 mb-4 bg-gray-50 max-h-[calc(100vh-300px)] min-h-[200px]">
                {chatHistory.length === 0 ? (
                    <p className="text-gray-500 text-center">Xin chào, tôi là thư ký AI của bạn. Bạn cần giúp gì?</p>
                ) : (
                    chatHistory.map((msg, index) => (
                        <div key={index} className={`mb-3 ${msg.role === 'user' ? 'text-right' : 'text-left'}`}>
                            <span className={`inline-block p-3 rounded-lg max-w-[80%] ${msg.role === 'user' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-800'}`}>
                                {msg.parts[0].text}
                            </span>
                        </div>
                    ))
                )}
                {isThinking && (
                    <div className="text-left mb-3">
                        <span className="inline-block p-3 rounded-lg bg-gray-200 text-gray-800 animate-pulse">
                            AI đang suy nghĩ...
                        </span>
                    </div>
                )}
            </div>
            <div className="flex">
                <input
                    type="text"
                    placeholder="Nhập tin nhắn của bạn..."
                    className="flex-1 p-3 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    value={input}
                    onChange={(e) => setInput(e.target.value)}
                    onKeyPress={(e) => {
                        if (e.key === 'Enter') {
                            handleSendMessage();
                        }
                    }}
                    disabled={isThinking}
                />
                <button
                    onClick={handleSendMessage}
                    className="bg-blue-500 text-white px-6 py-3 rounded-r-lg hover:bg-blue-600 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled={isThinking}
                >
                    Gửi
                </button>
            </div>
            <p className="text-sm text-gray-500 mt-2">
                Bạn có thể nhập các yêu cầu như "Thêm chi phí 500000 cho tiền điện nước", "Thêm sản phẩm: Bút bi, giá 5000, tồn kho 200", hoặc "cho tôi lời khuyên tài chính".
            </p>
        </div>
    );
};

export default App;

