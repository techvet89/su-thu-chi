<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Theme Color for browsers -->
    <meta name="theme-color" content="#0284c7"/>

    <title>Sổ Thu Chi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .summary-card {
            transition: transform 0.2s ease-in-out;
        }
        .summary-card:hover {
            transform: translateY(-4px);
        }
        .transaction-item:last-child {
            border-bottom: none;
        }
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        /* Animation for error box */
        @keyframes pulse-border {
          0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
          70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
          100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .pulsing-error {
          animation: pulse-border 2s infinite;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    
    <!-- AUTHENTICATION ERROR OVERLAY -->
    <div id="auth-error-overlay" class="fixed inset-0 bg-white z-50 p-6 text-center flex items-center justify-center hidden">
        <div class="max-w-2xl mx-auto border-4 border-orange-500 rounded-2xl p-8 shadow-2xl pulsing-error">
            <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h1 class="text-3xl font-bold text-orange-600 mt-4 mb-4">HÀNH ĐỘNG BẮT BUỘC</h1>
            <p class="text-gray-700 text-lg mb-6">Bạn cần bật "Đăng nhập ẩn danh" trong Firebase để ứng dụng hoạt động.</p>
            <div class="text-left bg-gray-100 p-4 rounded-lg border border-gray-200 space-y-3">
                <p><strong>Bước 1:</strong> Mở <a href="https://console.firebase.google.com/" target="_blank" class="text-blue-600 underline font-semibold">Firebase Console</a>, vào dự án của bạn, chọn mục <strong>Authentication</strong> từ menu bên trái.</p>
                <p><strong>Bước 2:</strong> Nhấp vào tab <strong>Sign-in method</strong>.</p>
                <p><strong>Bước 3:</strong> Nhấn nút <strong>Add new provider</strong>, chọn <strong>Anonymous</strong>, gạt nút **Enable** và nhấn **Save**.</p>
            </div>
            <p class="mt-6 text-base text-gray-600">Sau khi bật tính năng này, hãy <a href="javascript:location.reload();" class="text-blue-600 underline font-semibold">tải lại trang này</a>.</p>
        </div>
    </div>

    <!-- MAIN CONTAINER -->
    <div id="main-container" class="container mx-auto max-w-2xl p-4 md:p-6">
        
        <!-- HEADER -->
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-900">Sổ Thu Chi</h1>
            <p class="text-gray-500 mt-1">Quản lý tài chính cá nhân của bạn một cách thông minh.</p>
        </header>

        <!-- SUMMARY SECTION - UPDATED -->
        <section id="summary" class="grid grid-cols-2 md:grid-cols-2 gap-4 mb-6">
            <div class="summary-card bg-white p-4 rounded-xl border border-gray-200 shadow-sm col-span-2 grid grid-cols-2 gap-4">
                 <div>
                    <h3 class="text-sm font-medium text-green-600">Tổng Thu</h3>
                    <p id="total-income" class="text-xl font-semibold text-green-500">0 ₫</p>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-red-600">Tổng Chi</h3>
                    <p id="total-expense" class="text-xl font-semibold text-red-500">0 ₫</p>
                </div>
            </div>
            <div class="summary-card bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                <h3 class="text-sm font-medium text-blue-600">Số dư tiền mặt</h3>
                <p id="cash-balance" class="text-2xl font-semibold text-blue-500">0 ₫</p>
            </div>
            <div class="summary-card bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                <h3 class="text-sm font-medium text-indigo-600">Số dư tài khoản</h3>
                <p id="bank-balance" class="text-2xl font-semibold text-indigo-500">0 ₫</p>
            </div>
        </section>

        <!-- ACTION BUTTONS -->
        <section class="flex justify-center gap-4 mb-6">
             <button id="open-ai-modal-btn" class="flex-1 bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-200 flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 01-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 013.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 013.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 01-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.624L16.5 21.75l-.398-1.126a3.375 3.375 0 00-2.456-2.456L12.75 18l1.126-.398a3.375 3.375 0 002.456-2.456L16.5 14.25l.398 1.126a3.375 3.375 0 002.456 2.456L20.25 18l-1.126.398a3.375 3.375 0 00-2.456 2.456z" /></svg>
                Nhập bằng AI
            </button>
            <button id="open-add-modal-btn" class="flex-1 bg-gray-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75 transition duration-200 flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                Thêm thủ công
            </button>
        </section>

        <!-- TRANSACTIONS LIST -->
        <section>
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Giao dịch gần đây</h2>
            <div id="transactions-list" class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                <p id="no-transactions-msg" class="text-center text-gray-500 p-8">Chưa có giao dịch nào.</p>
            </div>
        </section>
        
        <div id="user-info" class="text-center mt-6 text-xs text-gray-400 break-all p-2 rounded-lg bg-gray-100">
            Đang tải User ID...
        </div>
    </div>

    <!-- ADD/EDIT TRANSACTION MODAL - UPDATED -->
    <div id="add-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-6 transform scale-95 opacity-0">
            <h2 class="text-xl font-bold mb-4">Thêm Giao Dịch Mới</h2>
            <form id="add-form">
                <div class="mb-4">
                    <label for="type" class="block text-sm font-medium text-gray-700 mb-1">Loại giao dịch</label>
                    <select id="type" name="type" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="expense">Chi Tiêu</option>
                        <option value="income">Thu Nhập</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Mô tả</label>
                    <input type="text" id="description" name="description" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">Số tiền (₫)</label>
                    <input type="number" id="amount" name="amount" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="source" class="block text-sm font-medium text-gray-700 mb-1">Nguồn tiền</label>
                    <select id="source" name="source" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="bank">Tài khoản</option>
                        <option value="cash">Tiền mặt</option>
                    </select>
                </div>
                 <div class="mb-6">
                    <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Danh mục</label>
                    <input type="text" id="category" name="category" list="categories" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="VD: Ăn uống, Di chuyển...">
                    <datalist id="categories">
                        <option value="Ăn uống">
                        <option value="Di chuyển">
                        <option value="Mua sắm">
                        <option value="Hóa đơn">
                        <option value="Giải trí">
                        <option value="Lương">
                        <option value="Khác">
                    </datalist>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-add-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Hủy</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Lưu</button>
                </div>
            </form>
        </div>
    </div>

    <!-- AI IMPORT MODAL -->
    <div id="ai-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-6 transform scale-95 opacity-0">
            <h2 class="text-xl font-bold mb-2">Nhập liệu bằng AI</h2>
            <p class="text-sm text-gray-500 mb-4">Nhập yêu cầu bằng ngôn ngữ tự nhiên hoặc dán nội dung tin nhắn vào đây.</p>
            <form id="ai-form">
                <textarea id="ai-input" rows="6" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Ví dụ: chi 50k tiền mặt uống cafe, hoặc dán nội dung SMS từ ngân hàng..."></textarea>
                <div id="ai-status" class="text-sm text-yellow-600 mt-2 h-5"></div>
                <div class="flex justify-end gap-4 mt-4">
                    <button type="button" id="cancel-ai-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Hủy</bitton>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 flex items-center justify-center gap-2">
                        <span id="ai-submit-text">Xử lý</span>
                        <svg id="ai-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-900 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 translate-y-10 transition-all duration-300">
        <p id="toast-message"></p>
    </div>

    <script>
        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
    <script type="module">
        // Import các hàm cần thiết từ Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIG & INITIALIZATION ---
        
        // CẤU HÌNH FIREBASE ĐÃ ĐƯỢC TỰ ĐỘNG CẬP NHẬT
        const firebaseConfig = {
          apiKey: "AIzaSyDY-LHMVcRN_mRuxSmO-4fTcQoMQvxaMRE",
          authDomain: "do12341.firebaseapp.com",
          projectId: "do12341",
          storageBucket: "do12341.appspot.com",
          messagingSenderId: "727920669744",
          appId: "1:727920669744:web:7e9c43d26626083d6969f5",
          measurementId: "G-V7RMVF8JDM"
        };
        
        let db, auth, userId, transactionsUnsubscribe;

        // --- UI ELEMENTS ---
        const mainContainer = document.getElementById('main-container');
        const authErrorOverlay = document.getElementById('auth-error-overlay');
        const totalIncomeEl = document.getElementById('total-income');
        const totalExpenseEl = document.getElementById('total-expense');
        const cashBalanceEl = document.getElementById('cash-balance');
        const bankBalanceEl = document.getElementById('bank-balance');
        const transactionsListEl = document.getElementById('transactions-list');
        const noTransactionsMsg = document.getElementById('no-transactions-msg');
        const userInfoEl = document.getElementById('user-info');
        const aiSubmitBtn = document.querySelector('#ai-form button[type="submit"]');
        const aiSubmitText = document.getElementById('ai-submit-text');
        const aiSpinner = document.getElementById('ai-spinner');

        // Modals
        const addModal = document.getElementById('add-modal');
        const aiModal = document.getElementById('ai-modal');
        const addForm = document.getElementById('add-form');
        const aiForm = document.getElementById('ai-form');

        // Toast
        const toastEl = document.getElementById('toast');
        const toastMessageEl = document.getElementById('toast-message');

        // --- HELPER FUNCTIONS ---
        function showToast(message, duration = 3000) {
            toastMessageEl.textContent = message;
            toastEl.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => {
                toastEl.classList.add('opacity-0', 'translate-y-10');
            }, duration);
        }
        
        function formatCurrency(num) {
            if (typeof num !== 'number') return '0 ₫';
            return num.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
        }

        function toggleModal(modal, show) {
            const content = modal.querySelector('.modal-content');
            if (show) {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('bg-opacity-0');
                    if (content) content.classList.remove('scale-95', 'opacity-0');
                }, 10);
            } else {
                modal.classList.add('bg-opacity-0');
                if (content) content.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
        }

        // --- RENDER FUNCTIONS ---
        function renderTransactions(transactions) {
            transactionsListEl.innerHTML = ''; 
            if (transactions.length === 0) {
                if(noTransactionsMsg) {
                    transactionsListEl.appendChild(noTransactionsMsg);
                    noTransactionsMsg.style.display = 'block';
                }
                return;
            }
            if(noTransactionsMsg) noTransactionsMsg.style.display = 'none';

            const sortedTransactions = transactions.sort((a, b) => {
                const dateA = a.createdAt?.toDate() || new Date(0);
                const dateB = b.createdAt?.toDate() || new Date(0);
                return dateB - dateA;
            });

            sortedTransactions.forEach(t => {
                const isExpense = t.type === 'expense';
                const sign = isExpense ? '-' : '+';
                const amountColor = isExpense ? 'text-red-500' : 'text-green-500';
                const date = t.createdAt?.toDate() ? t.createdAt.toDate().toLocaleDateString('vi-VN') : 'Không có ngày';
                const sourceText = t.source === 'cash' ? 'Tiền mặt' : 'Tài khoản';
                const sourceColor = t.source === 'cash' ? 'bg-blue-100 text-blue-800' : 'bg-indigo-100 text-indigo-800';

                const item = document.createElement('div');
                item.className = 'transaction-item flex items-center justify-between p-4 border-b border-gray-100';
                item.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center ${isExpense ? 'bg-red-100' : 'bg-green-100'}">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 ${amountColor}">
                              <path stroke-linecap="round" stroke-linejoin="round" d="${isExpense ? 'M2.25 18L9 11.25l4.328 4.329 7.09-7.091M2.25 12.75h7.5m7.5 7.5h-7.5' : 'M2.25 6L9 12.75l4.328-4.329 7.09 7.091M2.25 11.25h7.5m7.5-7.5h-7.5'}" />
                            </svg>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-800">${t.description}</p>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-xs px-2 py-0.5 rounded-full ${sourceColor}">${sourceText}</span>
                                <p class="text-sm text-gray-500">${t.category || 'Chưa phân loại'} · ${date}</p>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold ${amountColor}">${sign}${formatCurrency(t.amount)}</p>
                        <button data-id="${t.id}" class="delete-btn text-xs text-gray-400 hover:text-red-500 mt-1">Xóa</button>
                    </div>
                `;
                transactionsListEl.appendChild(item);
            });
        }

        // UPDATED SUMMARY FUNCTION
        function updateSummary(transactions) {
            let totalIncome = 0;
            let totalExpense = 0;
            let cashBalance = 0;
            let bankBalance = 0;

            transactions.forEach(t => {
                if (t.type === 'income') {
                    totalIncome += t.amount;
                    if (t.source === 'cash') {
                        cashBalance += t.amount;
                    } else { // 'bank' or default
                        bankBalance += t.amount;
                    }
                } else { // 'expense'
                    totalExpense += t.amount;
                    if (t.source === 'cash') {
                        cashBalance -= t.amount;
                    } else { // 'bank' or default
                        bankBalance -= t.amount;
                    }
                }
            });

            totalIncomeEl.textContent = formatCurrency(totalIncome);
            totalExpenseEl.textContent = formatCurrency(totalExpense);
            cashBalanceEl.textContent = formatCurrency(cashBalance);
            bankBalanceEl.textContent = formatCurrency(bankBalance);
        }

        // --- FIRESTORE LOGIC ---
        function getTransactions() {
            if (transactionsUnsubscribe) transactionsUnsubscribe();
            if (!userId) return;

            const transactionsCol = collection(db, `users/${userId}/transactions`);
            const q = query(transactionsCol);

            transactionsUnsubscribe = onSnapshot(q, (querySnapshot) => {
                const transactions = [];
                querySnapshot.forEach((doc) => {
                    transactions.push({ id: doc.id, ...doc.data() });
                });
                renderTransactions(transactions);
                updateSummary(transactions);
            }, (error) => {
                console.error("Lỗi khi lấy dữ liệu: ", error);
                showToast("Không thể tải dữ liệu. Vui lòng thử lại.");
            });
        }

        async function addTransaction(data) {
            if (!userId) {
                showToast("Lỗi: Không tìm thấy người dùng.");
                return false;
            }
            try {
                const transactionsCol = collection(db, `users/${userId}/transactions`);
                await addDoc(transactionsCol, {
                    ...data,
                    createdAt: serverTimestamp()
                });
                showToast("Đã thêm giao dịch thành công!");
                return true;
            } catch (error) {
                console.error("Lỗi khi thêm giao dịch: ", error);
                showToast("Thêm giao dịch thất bại.");
                return false;
            }
        }

        async function deleteTransaction(id) {
            if (!window.confirm('Bạn có chắc chắn muốn xóa giao dịch này?')) return;
            try {
                const docRef = doc(db, `users/${userId}/transactions`, id);
                await deleteDoc(docRef);
                showToast("Đã xóa giao dịch.");
            } catch (error) {
                console.error("Lỗi khi xóa giao dịch: ", error);
                showToast("Xóa giao dịch thất bại.");
            }
        }
        
        function setAISubmitButtonLoading(isLoading) {
            if (isLoading) {
                aiSubmitBtn.disabled = true;
                aiSubmitText.classList.add('hidden');
                aiSpinner.classList.remove('hidden');
            } else {
                aiSubmitBtn.disabled = false;
                aiSubmitText.classList.remove('hidden');
                aiSpinner.classList.add('hidden');
            }
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            document.getElementById('open-add-modal-btn').addEventListener('click', () => toggleModal(addModal, true));
            document.getElementById('open-ai-modal-btn').addEventListener('click', () => toggleModal(aiModal, true));

            document.getElementById('cancel-add-btn').addEventListener('click', () => toggleModal(addModal, false));
            document.getElementById('cancel-ai-btn').addEventListener('click', () => toggleModal(aiModal, false));
            addModal.addEventListener('click', (e) => { if (e.target.id === 'add-modal') toggleModal(addModal, false); });
            aiModal.addEventListener('click', (e) => { if (e.target.id === 'ai-modal') toggleModal(aiModal, false); });

            // UPDATED ADD FORM
            addForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const success = await addTransaction({
                    type: addForm.type.value,
                    description: addForm.description.value,
                    amount: parseFloat(addForm.amount.value),
                    source: addForm.source.value, // Added source
                    category: addForm.category.value
                });
                if (success) {
                    addForm.reset();
                    toggleModal(addModal, false);
                }
            });

            // UPDATED AI FORM
            aiForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userInput = document.getElementById('ai-input').value;
                const statusEl = document.getElementById('ai-status');
                if (!userInput.trim()) {
                    statusEl.textContent = "Vui lòng nhập nội dung.";
                    return;
                }
                statusEl.textContent = "AI đang phân tích...";
                setAISubmitButtonLoading(true);

                try {
                    const prompt = `Bạn là một trợ lý tài chính chuyên nghiệp. Phân tích văn bản tiếng Việt sau đây và trích xuất chi tiết giao dịch.
                    Văn bản: "${userInput}"
                    
                    Hãy trả về kết quả CHỈ LÀ một đối tượng JSON, không có bất kỳ văn bản giải thích hay định dạng markdown nào.
                    Đối tượng JSON phải có các trường sau: "amount" (NUMBER), "description" (STRING), "type" ('income' hoặc 'expense'), "category" (STRING), và "source" ('cash' hoặc 'bank').
                    - Chuyển đổi các giá trị như 'k' thành '000' và 'tr' thành '000000'.
                    - 'type' phải là 'expense' hoặc 'income'.
                    - 'category' nên được suy ra từ mô tả.
                    - 'source' phải là 'cash' nếu văn bản chứa từ "tiền mặt". Nếu không, hoặc nếu nó đề cập đến ngân hàng/thẻ, hãy mặc định là 'bank'.
                    - 'description' phải mô tả ngắn gọn giao dịch.`;

                    const payload = {
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                    };

                    const apiKey = ""; // API key is handled by the environment
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`API call failed with status: ${response.status}. Body: ${errorBody}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                        let jsonText = result.candidates[0].content.parts[0].text;
                        
                        const jsonMatch = jsonText.match(/```(json)?\s*([\s\S]*?)\s*```/);
                        if (jsonMatch && jsonMatch[2]) {
                            jsonText = jsonMatch[2];
                        }

                        const parsedData = JSON.parse(jsonText);

                        const success = await addTransaction(parsedData);
                        if (success) {
                            aiForm.reset();
                            statusEl.textContent = "";
                            toggleModal(aiModal, false);
                        } else {
                            statusEl.textContent = "Đã xảy ra lỗi khi lưu.";
                        }
                    } else {
                         throw new Error("Không nhận được phản hồi hợp lệ từ AI. Phản hồi: " + JSON.stringify(result));
                    }

                } catch (error) {
                    console.error("Lỗi khi gọi AI:", error);
                    statusEl.textContent = "AI không thể xử lý yêu cầu này.";
                    showToast("Lỗi AI: " + error.message, 5000);
                } finally {
                    setAISubmitButtonLoading(false);
                }
            });

            transactionsListEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const id = e.target.dataset.id;
                    deleteTransaction(id);
                }
            });
        }

        // --- INITIALIZATION ---
        async function main() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userInfoEl.textContent = `User ID: ${userId}`;
                        getTransactions();
                    } else {
                        signInAnonymously(auth).catch(error => {
                            console.error("Lỗi đăng nhập ẩn danh:", error);
                            // Check for the specific error code for disabled anonymous auth
                            if (error.code === 'auth/operation-not-allowed' || error.code === 'auth/admin-restricted-operation') {
                                mainContainer.style.display = 'none';
                                authErrorOverlay.classList.remove('hidden');
                            } else {
                                userInfoEl.textContent = "Không thể xác thực người dùng.";
                                showToast("Lỗi xác thực: " + error.message, 5000);
                            }
                        });
                    }
                });

                setupEventListeners();
            } catch(e) {
                console.error("Lỗi khởi tạo Firebase: ", e);
                // Fallback for any other initialization error
                mainContainer.innerHTML = `<div class="p-6 text-center"><h1 class="text-2xl font-bold text-red-600">Lỗi Khởi Tạo Nghiêm Trọng</h1><p>${e.message}</p></div>`;
            }
        }

        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>
